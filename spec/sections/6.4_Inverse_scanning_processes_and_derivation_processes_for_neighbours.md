**6.4** **Inverse scanning processes and derivation processes for neighbours**


This clause specifies inverse scanning processes; i.e., the mapping of indices to locations, and derivation processes for
neighbours.


**6.4.1** **Inverse macroblock scanning process**


Input to this process is a macroblock address mbAddr.


Output of this process is the location ( x, y ) of the upper-left luma sample for the macroblock with address mbAddr relative
to the upper-left sample of the picture.


The inverse macroblock scanning process is specified as follows:

- If MbaffFrameFlag is equal to 0,


x = InverseRasterScan( mbAddr, 16, 16, PicWidthInSamplesL, 0 ) (6-3)


y = InverseRasterScan( mbAddr, 16, 16, PicWidthInSamplesL, 1 ) (6-4)


- Otherwise (MbaffFrameFlag is equal to 1), the following ordered steps are specified:


1. The luma location ( xO, yO ) is derived by


xO = InverseRasterScan( mbAddr / 2, 16, 32, PicWidthInSamplesL, 0 ) (6-5)


yO = InverseRasterScan( mbAddr / 2, 16, 32, PicWidthInSamplesL, 1 ) (6-6)


2. Depending on the current macroblock the following applies:


     - If the current macroblock is a frame macroblock


x = xO (6-7)


y = yO + ( mbAddr % 2 ) * 16 (6-8)


     - Otherwise (the current macroblock is a field macroblock),


x = xO (6-9)


y = yO + ( mbAddr % 2 ) (6-10)


**6.4.2** **Inverse macroblock partition and sub-macroblock partition scanning process**


Macroblocks or sub-macroblocks may be partitioned, and the partitions are scanned for inter prediction as shown in
Figure 6-9. The outer rectangles refer to the samples in a macroblock or sub-macroblock, respectively. The rectangles refer
to the partitions. The number in each rectangle specifies the index of the inverse macroblock partition scan or inverse submacroblock partition scan.





The functions MbPartWidth( ), MbPartHeight( ), SubMbPartWidth( ), and SubMbPartHeight( ) describing the width and
height of macroblock partitions and sub-macroblock partitions are specified in Tables 7-13, 7-14, 7-17, and 7-18.
MbPartWidth( ) and MbPartHeight( ) are set to appropriate values for each macroblock, depending on the macroblock
type. SubMbPartWidth( ) and SubMbPartHeight( ) are set to appropriate values for each sub-macroblock of a macroblock
with mb_type equal to P_8x8, P_8x8ref0, or B_8x8, depending on the sub-macroblock type.



































**Figure 6-9 – Macroblock partitions, sub-macroblock partitions, macroblock partition scans,**

**and sub-macroblock partition scans**


**6.4.2.1** **Inverse macroblock partition scanning process**


Input to this process is the index of a macroblock partition mbPartIdx.


Output of this process is the location ( x, y ) of the upper-left luma sample for the macroblock partition mbPartIdx relative
to the upper-left sample of the macroblock.


The inverse macroblock partition scanning process is specified by


x = InverseRasterScan( mbPartIdx, MbPartWidth( mb_type ), MbPartHeight( mb_type ), 16, 0 ) (6-11)


y = InverseRasterScan( mbPartIdx, MbPartWidth( mb_type ), MbPartHeight( mb_type ), 16, 1 ) (6-12)


**6.4.2.2** **Inverse sub-macroblock partition scanning process**


Inputs to this process are the index of a macroblock partition mbPartIdx and the index of a sub-macroblock partition
subMbPartIdx.


Output of this process is the location ( x, y ) of the upper-left luma sample for the sub-macroblock partition subMbPartIdx
relative to the upper-left sample of the sub-macroblock.


The inverse sub-macroblock partition scanning process is specified as follows:

- If mb_type is equal to P_8x8, P_8x8ref0, or B_8x8,


x = InverseRasterScan( subMbPartIdx, SubMbPartWidth( sub_mb_type[ mbPartIdx ] ),
SubMbPartHeight( sub_mb_type[ mbPartIdx ] ), 8, 0 ) (6-13)


y = InverseRasterScan( subMbPartIdx, SubMbPartWidth( sub_mb_type[ mbPartIdx ] ),
SubMbPartHeight( sub_mb_type[ mbPartIdx ] ), 8, 1 ) (6-14)


- Otherwise (mb_type is not equal to P_8x8, P_8x8ref0, or B_8x8),


x = InverseRasterScan( subMbPartIdx, 4, 4, 8, 0 ) (6-15)





y = InverseRasterScan( subMbPartIdx, 4, 4, 8, 1 ) (6-16)


**6.4.3** **Inverse 4x4 luma block scanning process**


Input to this process is the index of a 4x4 luma block luma4x4BlkIdx.


Output of this process is the location ( x, y ) of the upper-left luma sample for the 4x4 luma block with index
luma4x4BlkIdx relative to the upper-left luma sample of the macroblock.

|s.|Col2|Col3|Col4|
|---|---|---|---|
|0|1|4|5|
|2|3|6|7|
|8|9|12|13|
|10|11|14|15|



**Figure 6-10 – Scan for 4x4 luma blocks**


The inverse 4x4 luma block scanning process is specified by


x = InverseRasterScan( luma4x4BlkIdx / 4, 8, 8, 16, 0 ) +
InverseRasterScan( luma4x4BlkIdx % 4, 4, 4, 8, 0 ) (6-17)


y = InverseRasterScan( luma4x4BlkIdx / 4, 8, 8, 16, 1 ) +
InverseRasterScan( luma4x4BlkIdx % 4, 4, 4, 8, 1 ) (6-18)


**6.4.4** **Inverse 4x4 Cb or Cr block scanning process for ChromaArrayType equal to 3**


This process is only invoked when ChromaArrayType is equal to 3.


The inverse 4x4 chroma block scanning process is identical to inverse 4x4 luma block scanning process as specified in
clause 6.4.3 when substituting the term "luma" with the term "Cb" or the term "Cr", and substituting the term
"luma4x4BlkIdx" with the term "cb4x4BlkIdx" or the term "cr4x4BlkIdx" in all places in clause 6.4.3.


**6.4.5** **Inverse 8x8 luma block scanning process**


Input to this process is the index of an 8x8 luma block luma8x8BlkIdx.


Output of this process is the location ( x, y ) of the upper-left luma sample for the 8x8 luma block with index
luma8x8BlkIdx relative to the upper-left luma sample of the macroblock.

|s.|Col2|
|---|---|
|0|1|
|2|3|



**Figure 6-11 – Scan for 8x8 luma blocks**


The inverse 8x8 luma block scanning process is specified by:


x = InverseRasterScan( luma8x8BlkIdx, 8, 8, 16, 0 ) (6-19)


y = InverseRasterScan( luma8x8BlkIdx, 8, 8, 16, 1 ) (6-20)





**6.4.6** **Inverse 8x8 Cb or Cr block scanning process for ChromaArrayType equal to 3**


This process is only invoked when ChromaArrayType is equal to 3.


The inverse 8x8 chroma block scanning process is identical to inverse 8x8 luma block scanning process as specified in
clause 6.4.5 when substituting the term "luma" with the term "Cb" or the term "Cr", and substituting the term
"luma8x8BlkIdx" with the term "cb8x8BlkIdx" or the term "cr8x8BlkIdx" in all places in clause 6.4.5.


**6.4.7** **Inverse 4x4 chroma block scanning process**


Input to this process is the index of a 4x4 chroma block chroma4x4BlkIdx.


Output of this process is the location ( x, y ) of the upper-left chroma sample for a 4x4 chroma block with index
chroma4x4BlkIdx relative to the upper-left chroma sample of the macroblock.


The inverse 4x4 chroma block scanning process is specified by


x = InverseRasterScan( chroma4x4BlkIdx, 4, 4, 8, 0 ) (6-21)


y = InverseRasterScan( chroma4x4BlkIdx, 4, 4, 8, 1 ) (6-22)


**6.4.8** **Derivation process of the availability for macroblock addresses**


Input to this process is a macroblock address mbAddr.


Output of this process is the availability of the macroblock mbAddr.

NOTE – The meaning of availability is determined when this process is invoked.


The macroblock is marked as available, unless any of the following conditions are true, in which case the macroblock is
marked as not available:

- mbAddr < 0,

- mbAddr > CurrMbAddr,

- the macroblock with address mbAddr belongs to a different slice than the macroblock with address CurrMbAddr.


**6.4.9** **Derivation process for neighbouring macroblock addresses and their availability**


This process can only be invoked when MbaffFrameFlag is equal to 0.


The outputs of this process are:

- mbAddrA: the address and availability status of the macroblock to the left of the current macroblock,

- mbAddrB: the address and availability status of the macroblock above the current macroblock,

- mbAddrC: the address and availability status of the macroblock above-right of the current macroblock,

- mbAddrD: the address and availability status of the macroblock above-left of the current macroblock.


Figure 6-12 shows the relative spatial locations of the macroblocks with mbAddrA, mbAddrB, mbAddrC, and mbAddrD
relative to the current macroblock with CurrMbAddr.





|mbAddrD|mbAddrB|mbAddrC|
|---|---|---|
|mbAddrA|CurrMbAddr||
||||


**Figure 6-12 – Neighbouring macroblocks for a given macroblock**


Input to the process in clause 6.4.8 is mbAddrA = CurrMbAddr − 1 and the output is whether the macroblock mbAddrA
is available. In addition, mbAddrA is marked as not available when CurrMbAddr % PicWidthInMbs is equal to 0.


Input to the process in clause 6.4.8 is mbAddrB = CurrMbAddr − PicWidthInMbs and the output is whether the
macroblock mbAddrB is available.


Input to the process in clause 6.4.8 is mbAddrC = CurrMbAddr − PicWidthInMbs + 1 and the output is whether the
macroblock mbAddrC is available. In addition, mbAddrC is marked as not available when
( CurrMbAddr + 1 ) % PicWidthInMbs is equal to 0.


Input to the process in clause 6.4.8 is mbAddrD = CurrMbAddr − PicWidthInMbs − 1 and the output is whether the
macroblock mbAddrD is available. In addition, mbAddrD is marked as not available when
CurrMbAddr % PicWidthInMbs is equal to 0.


**6.4.10** **Derivation process for neighbouring macroblock addresses and their availability in MBAFF frames**


This process can only be invoked when MbaffFrameFlag is equal to 1.


The outputs of this process are:

- mbAddrA: the address and availability status of the top macroblock of the macroblock pair to the left of the current
macroblock pair,

- mbAddrB: the address and availability status of the top macroblock of the macroblock pair above the current
macroblock pair,

- mbAddrC: the address and availability status of the top macroblock of the macroblock pair above-right of the current
macroblock pair,

- mbAddrD: the address and availability status of the top macroblock of the macroblock pair above-left of the current
macroblock pair.


Figure 6-13 shows the relative spatial locations of the macroblocks with mbAddrA, mbAddrB, mbAddrC, and mbAddrD
relative to the current macroblock with CurrMbAddr.


mbAddrA, mbAddrB, mbAddrC, and mbAddrD have identical values regardless whether the current macroblock is the top
or the bottom macroblock of a macroblock pair.





|mbAddrD|mbAddrB|mbAddrC|
|---|---|---|
||||
|mbAddrA|CurrMbAddr or||
||CurrMbAddr||


**Figure 6-13 – Neighbouring macroblocks for a given macroblock in MBAFF frames**


Input to the process in clause 6.4.8 is mbAddrA = 2 * ( CurrMbAddr / 2 − 1 ) and the output is whether the macroblock
mbAddrA is available. In addition, mbAddrA is marked as not available when ( CurrMbAddr / 2 ) % PicWidthInMbs is
equal to 0.


Input to the process in clause 6.4.8 is mbAddrB = 2 * ( CurrMbAddr / 2 − PicWidthInMbs ) and the output is whether the
macroblock mbAddrB is available.


Input to the process in clause 6.4.8 is mbAddrC = 2 * ( CurrMbAddr / 2 − PicWidthInMbs + 1 ) and the output is whether
the macroblock mbAddrC is available. In addition, mbAddrC is marked as not available when
( CurrMbAddr / 2 + 1) % PicWidthInMbs is equal to 0.


Input to the process in clause 6.4.8 is mbAddrD = 2 * ( CurrMbAddr / 2 − PicWidthInMbs − 1 ) and the output is whether
the macroblock mbAddrD is available. In addition, mbAddrD is marked as not available when
( CurrMbAddr / 2 ) % PicWidthInMbs is equal to 0.


**6.4.11** **Derivation processes for neighbouring macroblocks, blocks, and partitions**


Clause 6.4.11.1 specifies the derivation process for neighbouring macroblocks.


Clause 6.4.11.2 specifies the derivation process for neighbouring 8x8 luma blocks.


Clause 6.4.11.3 specifies the derivation process for neighbouring 8x8 chroma blocks for ChromaArrayType equal to 3.


Clause 6.4.11.4 specifies the derivation process for neighbouring 4x4 luma blocks.


Clause 6.4.11.5 specifies the derivation process for neighbouring 4x4 chroma blocks.


Clause 6.4.11.6 specifies the derivation process for neighbouring 4x4 chroma blocks for ChromaArrayType equal to 3.


Clause 6.4.11.7 specifies the derivation process for neighbouring partitions.


Table 6-2 specifies the values for the difference of luma location ( xD, yD ) for the input and the replacement for N in
mbAddrN, mbPartIdxN, subMbPartIdxN, luma8x8BlkIdxN, cb8x8BlkIdxN, cr8x8BlkIdxN, luma4x4BlkIdxN,
cb4x4BlkIdxN, cr4x4BlkIdxN, and chroma4x4BlkIdxN for the output. These input and output assignments are used in
clauses 6.4.11.1 to 6.4.11.7. The variable predPartWidth is specified when Table 6-2 is referred to.


**Table 6-2 – Specification of input and output assignments for clauses 6.4.11.1 to 6.4.11.7**

|N|xD|yD|
|---|---|---|
|A|−1|0|
|B|0|−1|
|C|predPartWidth|−1|
|D|−1|−1|



Figure 6-14 illustrates the relative location of the neighbouring macroblocks, blocks, or partitions A, B, C, and D to the
current macroblock, partition, or block, when the current macroblock, partition, or block is in frame coding mode.





D B C



A



Current
Macroblock

or Partition

or Block



**Figure 6-14 – Determination of the neighbouring macroblock, blocks, and partitions (informative)**


**6.4.11.1** **Derivation process for neighbouring macroblocks**


Outputs of this process are:

- mbAddrA: the address of the macroblock to the left of the current macroblock and its availability status,

- mbAddrB: the address of the macroblock above the current macroblock and its availability status.


mbAddrN (with N being A or B) is derived as specified by the following ordered steps:


1. The difference of luma location ( xD, yD ) is set according to Table 6-2.


2. The derivation process for neighbouring locations as specified in clause 6.4.12 is invoked for luma locations with

( xN, yN ) equal to ( xD, yD ), and the output is assigned to mbAddrN.


**6.4.11.2** **Derivation process for neighbouring 8x8 luma block**


Input to this process is an 8x8 luma block index luma8x8BlkIdx.


The luma8x8BlkIdx specifies the 8x8 luma blocks of a macroblock in a raster scan.


Outputs of this process are:

- mbAddrA: either equal to CurrMbAddr or the address of the macroblock to the left of the current macroblock and its
availability status,

- luma8x8BlkIdxA: the index of the 8x8 luma block to the left of the 8x8 block with index luma8x8BlkIdx and its
availability status,

- mbAddrB: either equal to CurrMbAddr or the address of the macroblock above the current macroblock and its
availability status,

- luma8x8BlkIdxB: the index of the 8x8 luma block above the 8x8 block with index luma8x8BlkIdx and its availability
status.


mbAddrN and luma8x8BlkIdxN (with N being A or B) are derived as specified by the following ordered steps:


1. The difference of luma location ( xD, yD ) is set according to Table 6-2.


2. The luma location ( xN, yN ) is specified by


xN = ( luma8x8BlkIdx % 2 ) * 8 + xD (6-23)


yN = ( luma8x8BlkIdx / 2 ) * 8 + yD (6-24)


3. The derivation process for neighbouring locations as specified in clause 6.4.12 is invoked for luma locations with

( xN, yN ) as the input and the output is assigned to mbAddrN and ( xW, yW ).


4. The variable luma8x8BlkIdxN is derived as follows:


      - If mbAddrN is not available, luma8x8BlkIdxN is marked as not available.


      - Otherwise (mbAddrN is available), the derivation process for 8x8 luma block indices as specified in
clause 6.4.13.3 is invoked with the luma location ( xW, yW ) as the input and the output is assigned
to luma8x8BlkIdxN.





**6.4.11.3** **Derivation process for neighbouring 8x8 chroma blocks for ChromaArrayType equal to 3**


This process is only invoked when ChromaArrayType is equal to 3.


The derivation process for neighbouring 8x8 chroma block is identical to the derivation process for neighbouring 8x8 luma
block as specified in clause 6.4.11.2 when substituting the term "luma" with the term "Cb" or the term "Cr", and substituting
the term "luma8x8BlkIdx" with the term "cb8x8BlkIdx" or the term "cr8x8BlkIdx" in all places in clause 6.4.11.2.


**6.4.11.4** **Derivation process for neighbouring 4x4 luma blocks**


Input to this process is a 4x4 luma block index luma4x4BlkIdx.


Outputs of this process are:

- mbAddrA: either equal to CurrMbAddr or the address of the macroblock to the left of the current macroblock and its
availability status,

- luma4x4BlkIdxA: the index of the 4x4 luma block to the left of the 4x4 block with index luma4x4BlkIdx and its
availability status,

- mbAddrB: either equal to CurrMbAddr or the address of the macroblock above the current macroblock and its
availability status,

- luma4x4BlkIdxB: the index of the 4x4 luma block above the 4x4 block with index luma4x4BlkIdx and its availability
status.


mbAddrN and luma4x4BlkIdxN (with N being A or B) are derived as specified by the following ordered steps:


1. The difference of luma location ( xD, yD ) is set according to Table 6-2.


2. The inverse 4x4 luma block scanning process as specified in clause 6.4.3 is invoked with luma4x4BlkIdx as the

input and ( x, y ) as the output.


3. The luma location ( xN, yN ) is specified by:


xN = x + xD (6-25)


yN = y + yD (6-26)


4. The derivation process for neighbouring locations as specified in clause 6.4.12 is invoked for luma locations with

( xN, yN ) as the input and the output is assigned to mbAddrN and ( xW, yW ).


5. The variable luma4x4BlkIdxN is derived as follows:


      - If mbAddrN is not available, luma4x4BlkIdxN is marked as not available.


      - Otherwise (mbAddrN is available), the derivation process for 4x4 luma block indices as specified in
clause 6.4.13.1 is invoked with the luma location ( xW, yW ) as the input and the output is assigned
to luma4x4BlkIdxN.


**6.4.11.5** **Derivation process for neighbouring 4x4 chroma blocks**


This clause is only invoked when ChromaArrayType is equal to 1 or 2.


Input to this process is a 4x4 chroma block index chroma4x4BlkIdx.


Outputs of this process are:

- mbAddrA (either equal to CurrMbAddr or the address of the macroblock to the left of the current macroblock) and
its availability status,

- chroma4x4BlkIdxA (the index of the 4x4 chroma block to the left of the 4x4 chroma block with index
chroma4x4BlkIdx) and its availability status,

- mbAddrB (either equal to CurrMbAddr or the address of the macroblock above the current macroblock) and its
availability status,

- chroma4x4BlkIdxB (the index of the 4x4 chroma block above the 4x4 chroma block with index chroma4x4BlkIdx)
and its availability status.

mbAddrN and chroma4x4BlkIdxN (with N being A or B) are derived as specified by the following ordered steps:


1. The difference of chroma location ( xD, yD ) is set according to Table 6-2.


2. The inverse 4x4 chroma block scanning process as specified in clause 6.4.7 is invoked with chroma4x4BlkIdx as

the input and ( x, y ) as the output.





3. The chroma location ( xN, yN ) is specified by


xN = x + xD (6-27)


yN = y + yD (6-28)


4. The derivation process for neighbouring locations as specified in clause 6.4.12 is invoked for chroma locations

with ( xN, yN ) as the input and the output is assigned to mbAddrN and ( xW, yW ).


5. The variable chroma4x4BlkIdxN is derived as follows:


      - If mbAddrN is not available, chroma4x4BlkIdxN is marked as not available.


      - Otherwise (mbAddrN is available), the derivation process for 4x4 chroma block indices as specified in
clause 6.4.13.2 is invoked with the chroma location ( xW, yW ) as the input and the output is assigned to
chroma4x4BlkIdxN.


**6.4.11.6** **Derivation process for neighbouring 4x4 chroma blocks for ChromaArrayType equal to 3**


This process is only invoked when ChromaArrayType is equal to 3.


The derivation process for neighbouring 4x4 chroma block in 4:4:4 chroma format is identical to the derivation process
for neighbouring 4x4 luma block as specified in clause 6.4.11.4 when substituting the term "luma" with the term "Cb" or
the term "Cr", and substituting the term "luma4x4BlkIdx" with the term "cb4x4BlkIdx" or the term "cr4x4BlkIdx" in all
places in clause 6.4.11.4.


**6.4.11.7** **Derivation process for neighbouring partitions**


Inputs to this process are:


- a macroblock partition index mbPartIdx


- a current sub-macroblock type currSubMbType


- a sub-macroblock partition index subMbPartIdx


Outputs of this process are:


- mbAddrA\mbPartIdxA\subMbPartIdxA: specifying the macroblock or sub-macroblock partition to the left of the
current macroblock and its availability status, or the sub-macroblock partition CurrMbAddr\mbPartIdx\subMbPartIdx
and its availability status,


- mbAddrB\mbPartIdxB\subMbPartIdxB: specifying the macroblock or sub-macroblock partition above the current
macroblock and its availability status, or the sub-macroblock partition CurrMbAddr\mbPartIdx\subMbPartIdx and its
availability status,


- mbAddrC\mbPartIdxC\subMbPartIdxC: specifying the macroblock or sub-macroblock partition to the right-above of
the current macroblock and its availability status, or the sub-macroblock partition
CurrMbAddr\mbPartIdx\subMbPartIdx and its availability status,


- mbAddrD\mbPartIdxD\subMbPartIdxD: specifying the macroblock or sub-macroblock partition to the left-above of
the current macroblock and its availability status, or the sub-macroblock partition
CurrMbAddr\mbPartIdx\subMbPartIdx and its availability status.


mbAddrN, mbPartIdxN, and subMbPartIdxN (with N being A, B, C, or D) are derived as specified by the following ordered
steps:


1. The inverse macroblock partition scanning process as described in clause 6.4.2.1 is invoked with mbPartIdx as

the input and ( x, y ) as the output.


2. The location of the upper-left luma sample inside a macroblock partition ( xS, yS ) is derived as follows:


      - If mb_type is equal to P_8x8, P_8x8ref0 or B_8x8, the inverse sub-macroblock partition scanning process
as described in clause 6.4.2.2 is invoked with subMbPartIdx as the input and ( xS, yS ) as the output.


      - Otherwise, ( xS, yS ) are set to ( 0, 0 ).


3. The variable predPartWidth in Table 6-2 is specified as follows:


      - If mb_type is equal to P_Skip, B_Skip, or B_Direct_16x16, predPartWidth = 16.


      - Otherwise, if mb_type is equal to B_8x8, the following applies:





        - If currSubMbType is equal to B_Direct_8x8, predPartWidth = 16.

NOTE 1 – When currSubMbType is equal to B_Direct_8x8 and direct_spatial_mv_pred_flag is equal to 1,
the predicted motion vector is the predicted motion vector for the complete macroblock.


        - Otherwise, predPartWidth = SubMbPartWidth( sub_mb_type[ mbPartIdx ] ).


      - Otherwise, if mb_type is equal to P_8x8 or P_8x8ref0,
predPartWidth = SubMbPartWidth( sub_mb_type[ mbPartIdx ] ).


      - Otherwise, predPartWidth = MbPartWidth( mb_type ).


4. The difference of luma location ( xD, yD ) is set according to Table 6-2.


5. The neighbouring luma location ( xN, yN ) is specified by


xN = x + xS + xD (6-29)


yN = y + yS + yD (6-30)


6. The derivation process for neighbouring locations as specified in clause 6.4.12 is invoked for luma locations with

( xN, yN ) as the input and the output is assigned to mbAddrN and ( xW, yW ).


7. Depending on mbAddrN, the following applies:


      - If mbAddrN is not available, the macroblock or sub-macroblock partition
mbAddrN\mbPartIdxN\subMbPartIdxN is marked as not available.


      - Otherwise (mbAddrN is available), the following ordered steps are specified:


a. Let mbTypeN be the syntax element mb_type of the macroblock with macroblock address
mbAddrN and, when mbTypeN is equal to P_8x8, P_8x8ref0, or B_8x8, let subMbTypeN be the
syntax element list sub_mb_type of the macroblock with macroblock address mbAddrN.


b. The derivation process for macroblock and sub-macroblock partition indices as specified in

clause 6.4.13.4 is invoked with the luma location ( xW, yW ), the macroblock type mbTypeN, and,
when mbTypeN is equal to P_8x8, P_8x8ref0, or B_8x8, the list of sub-macroblock types
subMbTypeN as the inputs and the outputs are the macroblock partition index mbPartIdxN and the
sub-macroblock partition index subMbPartIdxN.


c. When the partition given by mbPartIdxN and subMbPartIdxN is not yet decoded, the macroblock
partition mbPartIdxN and the sub-macroblock partition subMbPartIdxN are marked as not
available.
NOTE 2 – The latter condition is, for example, the case when mbPartIdx = 2, subMbPartIdx = 3, xD = 4, yD = −1,
i.e., when neighbour C of the last 4x4 luma block of the third sub-macroblock is requested.


**6.4.12** **Derivation process for neighbouring locations**


Input to this process is a luma or chroma location ( xN, yN ) expressed relative to the upper left corner of the current
macroblock.


Outputs of this process are:


- mbAddrN: either equal to CurrMbAddr or to the address of neighbouring macroblock that contains (xN, yN) and its
availability status,


- ( xW, yW ): the location (xN, yN) expressed relative to the upper-left corner of the macroblock mbAddrN (rather than
relative to the upper-left corner of the current macroblock).


Let maxW and maxH be variables specifying maximum values of the location components xN, xW, and yN, yW,
respectively. maxW and maxH are derived as follows:


- If this process is invoked for neighbouring luma locations,


maxW = maxH = 16 (6-31)


- Otherwise (this process is invoked for neighbouring chroma locations),


maxW = MbWidthC (6-32)


maxH = MbHeightC (6-33)





Depending on the variable MbaffFrameFlag, the neighbouring locations are derived as follows:


- If MbaffFrameFlag is equal to 0, the specification for neighbouring locations in fields and non-MBAFF frames as
described in clause 6.4.12.1 is applied.


- Otherwise (MbaffFrameFlag is equal to 1), the specification for neighbouring locations in MBAFF frames as described
in clause 6.4.12.2 is applied.


**6.4.12.1** **Specification for neighbouring locations in fields and non-MBAFF frames**


The specifications in this clause are applied when MbaffFrameFlag is equal to 0.


The derivation process for neighbouring macroblock addresses and their availability in clause 6.4.9 is invoked with
mbAddrA, mbAddrB, mbAddrC, and mbAddrD as well as their availability status as the output.


Table 6-3 specifies mbAddrN depending on ( xN, yN ).


**Table 6-3 – Specification of mbAddrN**

|xN|yN|mbAddrN|
|---|---|---|
|< 0|< 0|mbAddrD|
|< 0|0..maxH − 1|mbAddrA|
|0..maxW − 1|< 0|mbAddrB|
|0..maxW − 1|0..maxH − 1|CurrMbAddr|
|> maxW − 1|< 0|mbAddrC|
|> maxW − 1|0..maxH − 1|not available|
||> maxH − 1|not available|



The neighbouring location ( xW, yW ) relative to the upper-left corner of the macroblock mbAddrN is derived as


xW = ( xN + maxW ) % maxW (6-34)


yW = ( yN + maxH ) % maxH (6-35)


**6.4.12.2** **Specification for neighbouring locations in MBAFF frames**


The specifications in this clause are applied when MbaffFrameFlag is equal to 1.


The derivation process for neighbouring macroblock addresses and their availability in clause 6.4.10 is invoked with
mbAddrA, mbAddrB, mbAddrC, and mbAddrD as well as their availability status as the output.


The variable currMbFrameFlag is derived as follows:


- If the macroblock with address CurrMbAddr is a frame macroblock, currMbFrameFlag is set equal to 1.


- Otherwise (the macroblock with address CurrMbAddr is a field macroblock), currMbFrameFlag is set equal to 0.


The variable mbIsTopMbFlag is derived as follows:


- If the macroblock with address CurrMbAddr is a top macroblock (i.e., CurrMbAddr % 2 is equal to 0),
mbIsTopMbFlag is set equal to 1.


- Otherwise (the macroblock with address CurrMbAddr is a bottom macroblock, i.e., CurrMbAddr % 2 is equal to 1),
mbIsTopMbFlag is set equal to 0.


Table 6-4 specifies the macroblock addresses mbAddrN and yM in two ordered steps:


1. Specification of a macroblock address mbAddrX depending on ( xN, yN ) and the variables currMbFrameFlag

and mbIsTopMbFlag:


2. Depending on the availability of mbAddrX, the following applies:


     - If mbAddrX is not available, mbAddrN is marked as not available.





     - Otherwise (mbAddrX is available), mbAddrN is marked as available and Table 6-4 specifies mbAddrN and
yM depending on ( xN, yN ), currMbFrameFlag, mbIsTopMbFlag, and the variable mbAddrXFrameFlag,
which is derived as follows:


        - If the macroblock mbAddrX is a frame macroblock, mbAddrXFrameFlag is set equal to 1.


        - Otherwise (the macroblock mbAddrX is a field macroblock), mbAddrXFrameFlag is set equal to 0.


Unspecified values (na) of the above flags in Table 6-4 indicate that the value of the corresponding flag is not relevant for
the current table rows.


**Table 6-4 – Specification of mbAddrN and yM**


































|xN|yN|currMbFrameFlag|mbIsTopMbFlag|mbAddrX|mbAddrXFrameFlag|additional condition|mbAddrN|yM|
|---|---|---|---|---|---|---|---|---|
|< 0|< 0|1|1|mbAddrD|||mbAddrD + 1|yN|
|< 0|< 0|1|0|mbAddrA|1||mbAddrA|yN|
|< 0|< 0|1|0|mbAddrA|0||mbAddrA + 1|( yN + maxH ) >> 1|
|< 0|< 0|0|1|mbAddrD|1||mbAddrD + 1|2*yN|
|< 0|< 0|0|1|mbAddrD|0||mbAddrD|yN|
|< 0|< 0|0|0|mbAddrD|||mbAddrD + 1|yN|
|< 0|0..maxH − 1|<br>1|1|mbAddrA|1||mbAddrA|yN|
|< 0|0..maxH − 1|<br>1|1|mbAddrA|0|yN % 2 = = 0|mbAddrA|yN >> 1|
|< 0|0..maxH − 1|<br>1|1|mbAddrA|0|yN % 2 != 0|mbAddrA + 1|yN >> 1|
|< 0|0..maxH − 1|<br>1|0|mbAddrA|1||mbAddrA + 1|yN|
|< 0|0..maxH − 1|<br>1|0|mbAddrA|0|yN % 2 = = 0|mbAddrA|( yN + maxH ) >> 1|
|< 0|0..maxH − 1|<br>1|0|mbAddrA|0|yN % 2 != 0|mbAddrA + 1|( yN + maxH ) >> 1|
|< 0|0..maxH − 1|<br>0|1|mbAddrA|1|yN < ( maxH / 2 )|mbAddrA|yN <<1|
|< 0|0..maxH − 1|<br>0|1|mbAddrA|1|yN >= ( maxH / 2 )|mbAddrA + 1|( yN <<1 ) − maxH|
|< 0|0..maxH − 1|<br>0|1|mbAddrA|0||mbAddrA|yN|
|< 0|0..maxH − 1|<br>0|0|mbAddrA|1|yN < ( maxH / 2 )|mbAddrA|( yN <<1 ) + 1|
|< 0|0..maxH − 1|<br>0|0|mbAddrA|1|yN >= ( maxH / 2 )|mbAddrA + 1|( yN <<1 ) + 1 − maxH|
|< 0|0..maxH − 1|<br>0|0|mbAddrA|0||mbAddrA + 1|yN|
|0..maxW − 1|< 0|1|1|mbAddrB|||mbAddrB + 1|yN|
|0..maxW − 1|< 0|1|0|CurrMbAddr|||CurrMbAddr − 1|yN|
|0..maxW − 1|< 0|0|1|mbAddrB|1||mbAddrB + 1|2 * yN|
|0..maxW − 1|< 0|0|1|mbAddrB|0||mbAddrB|yN|
|0..maxW − 1|< 0|0|0|mbAddrB|||mbAddrB + 1|yN|
|0..maxW − 1|0..maxH − 1|||CurrMbAddr|||CurrMbAddr|yN|
|> maxW − 1|<0|1|1|mbAddrC|||mbAddrC + 1|yN|
|> maxW − 1|<0|1|0|not available|||not available|na|
|> maxW − 1|<0|0|1|mbAddrC|1||mbAddrC + 1|2 * yN|
|> maxW − 1|<0|0|1|mbAddrC|0||mbAddrC|yN|
|> maxW − 1|<0|0|0|mbAddrC|||mbAddrC + 1|yN|
|> maxW − 1|0..maxH − 1|||not available|||not available|na|
||> maxH − 1|||not available|||not available|na|



The neighbouring luma location ( xW, yW ) relative to the upper-left corner of the macroblock mbAddrN is derived as


xW = ( xN + maxW ) % maxW (6-36)





yW = ( yM + maxH ) % maxH (6-37)


**6.4.13** **Derivation processes for block and partition indices**


Clause 6.4.13.1 specifies the derivation process for 4x4 luma block indices.


Clause 6.4.13.2 specifies the derivation process for 4x4 chroma block indices.


Clause 6.4.13.3 specifies the derivation process for 8x8 luma block indices.


Clause 6.4.13.4 specifies the derivation process for macroblock and sub-macroblock partition indices.


**6.4.13.1** **Derivation process for 4x4 luma block indices**


Input to this process is a luma location ( xP, yP ) relative to the upper-left luma sample of a macroblock.


Output of this process is a 4x4 luma block index luma4x4BlkIdx.


The 4x4 luma block index luma4x4BlkIdx is derived by


luma4x4BlkIdx = 8 * ( yP / 8 ) + 4 * ( xP / 8 ) + 2 * ( ( yP % 8 ) / 4 ) + ( ( xP % 8 ) / 4 ) (6-38)


**6.4.13.2** **Derivation process for 4x4 chroma block indices**


This clause is only invoked when ChromaArrayType is equal to 1 or 2.


Input to this process is a chroma location ( xP, yP ) relative to the upper-left chroma sample of a macroblock.


Output of this process is a 4x4 chroma block index chroma4x4BlkIdx.


The 4x4 chroma block index chroma4x4BlkIdx is derived by


chroma4x4BlkIdx = 2 * ( yP / 4 ) + ( xP / 4 ) (6-39)


**6.4.13.3** **Derivation process for 8x8 luma block indices**


Input to this process is a luma location ( xP, yP ) relative to the upper-left luma sample of a macroblock.


Outputs of this process is an 8x8 luma block index luma8x8BlkIdx.


The 8x8 luma block index luma8x8BlkIdx is derived by


luma8x8BlkIdx = 2 * ( yP / 8 ) + ( xP / 8 ) (6-40)


**6.4.13.4** **Derivation process for macroblock and sub-macroblock partition indices**


Inputs to this process are:


- a luma location ( xP, yP ) relative to the upper-left luma sample of a macroblock,


- a macroblock type mbType,


- when mbType is equal to P_8x8, P_8x8ref0, or B_8x8, a list of sub-macroblock types subMbType with 4 elements.


Outputs of this process are:


- a macroblock partition index mbPartIdx,


- a sub-macroblock partition index subMbPartIdx.


The macroblock partition index mbPartIdx is derived as follows:


- If mbType specifies an I macroblock type, mbPartIdx is set equal to 0.


- Otherwise (mbType does not specify an I macroblock type), mbPartIdx is derived by


mbPartIdx = ( 16 / MbPartWidth( mbType ) ) * ( yP / MbPartHeight( mbType ) ) +
( xP / MbPartWidth( mbType ) ) (6-41)


The sub-macroblock partition index subMbPartIdx is derived as follows:


- If mbType is not equal to P_8x8, P_8x8ref0, B_8x8, B_Skip, or B_Direct_16x16, subMbPartIdx is set equal to 0.


- Otherwise, if mbType is equal to B_Skip or B_Direct_16x16, subMbPartIdx is derived by





subMbPartIdx = 2 * ( ( yP % 8 ) / 4 ) + ( ( xP % 8 ) / 4 ) (6-42)


- Otherwise (mbType is equal to P_8x8, P_8x8ref0, or B_8x8), subMbPartIdx is derived by


subMbPartIdx = ( 8 / SubMbPartWidth( subMbType[ mbPartIdx ] ) ) *
( ( yP % 8 ) / SubMbPartHeight( subMbType[ mbPartIdx ] ) ) +
( ( xP % 8 ) / SubMbPartWidth( subMbType[ mbPartIdx ] ) ) (6-43)
