**8.3** **Intra prediction process**


This process is invoked for I and SI macroblock types.


Inputs to this process are constructed samples prior to the deblocking filter process and, for Intra_NxN prediction modes
(where NxN is equal to 4x4 or 8x8), the values of IntraNxNPredMode from neighbouring macroblocks.


Outputs of this process are specified as follows:


- If the macroblock prediction mode is Intra_4x4 or Intra_8x8, the outputs are constructed luma samples prior to the
deblocking filter process and (when ChromaArrayType is not equal to 0) chroma prediction samples of the
macroblock predC, where C is equal to Cb and Cr.


- Otherwise, if mb_type is not equal to I_PCM, the outputs are luma prediction samples of the macroblock predL and
(when ChromaArrayType is not equal to 0) chroma prediction samples of the macroblock predC, where C is equal to
Cb and Cr.


- Otherwise (mb_type is equal to I_PCM), the outputs are constructed luma and (when ChromaArrayType is not
equal to 0) chroma samples prior to the deblocking filter process.


The variable MvCnt is set equal to 0.


Depending on the value of mb_type the following applies:


- If mb_type is equal to I_PCM, the sample construction process for I_PCM macroblocks as specified in clause 8.3.5
is invoked.


- Otherwise (mb_type is not equal to I_PCM), the following applies:


1. The decoding processes for Intra prediction modes are described for the luma component as follows:


      - If the macroblock prediction mode is equal to Intra_4x4, the Intra_4x4 prediction process for luma
samples as specified in clause 8.3.1 is invoked.


      - Otherwise, if the macroblock prediction mode is equal to Intra_8x8, the Intra_8x8 prediction process as
specified in clause 8.3.2 is invoked.





      - Otherwise (the macroblock prediction mode is equal to Intra_16x16), the Intra_16x16 prediction process
as specified in clause 8.3.3 is invoked with S′L as the input and the outputs are luma prediction samples
of the macroblock predL.


2. When ChromaArrayType is not equal to 0, the Intra prediction process for chroma samples as specified in

clause 8.3.4 is invoked with S′Cb, and S′Cr as the inputs and the outputs are chroma prediction samples of the
macroblock predCb and predCr.


Samples used in the Intra prediction process are the sample values prior to alteration by any deblocking filter operation.


**8.3.1** **Intra_4x4 prediction process for luma samples**


This process is invoked when the macroblock prediction mode is equal to Intra_4x4.


Inputs to this process are the values of Intra4x4PredMode (if available) or Intra8x8PredMode (if available) from
neighbouring macroblocks or macroblock pairs.


The luma component of a macroblock consists of 16 blocks of 4x4 luma samples. These blocks are inverse scanned using
the 4x4 luma block inverse scanning process as specified in clause 6.4.3.


For all 4x4 luma blocks of the luma component of a macroblock with luma4x4BlkIdx = 0..15, the derivation process for
the Intra4x4PredMode as specified in clause 8.3.1.1 is invoked with luma4x4BlkIdx as well as Intra4x4PredMode and
Intra8x8PredMode that are previously (in decoding order) derived for adjacent macroblocks as the input and the variable
Intra4x4PredMode[ luma4x4BlkIdx ] as the output.


For each luma block of 4x4 samples indexed using luma4x4BlkIdx = 0..15, the following ordered steps are specified:


1. The Intra_4x4 sample prediction process in clause 8.3.1.2 is invoked with luma4x4BlkIdx and the array S′L

containing constructed luma samples prior to the deblocking filter process from adjacent luma blocks as the inputs
and the outputs are the Intra_4x4 luma prediction samples pred4x4L[ x, y ] with x, y = 0..3.


2. The position of the upper-left sample of a 4x4 luma block with index luma4x4BlkIdx inside the current macroblock

is derived by invoking the inverse 4x4 luma block scanning process in clause 6.4.3 with luma4x4BlkIdx as the input
and the output being assigned to ( xO, yO ).


3. The values of the prediction samples predL[ xO + x, yO + y ] with x, y = 0..3 are derived by


predL[ xO + x, yO + y ] = pred4x4L[ x, y ] (8-40)


4. The transform coefficient decoding process and picture construction process prior to deblocking filter process in

clause 8.5 is invoked with predL and luma4x4BlkIdx as the input and the constructed samples for the current 4x4
luma block S′L as the output.


**8.3.1.1** **Derivation process for Intra4x4PredMode**


Inputs to this process are the index of the 4x4 luma block luma4x4BlkIdx and variable arrays Intra4x4PredMode (if
available) and Intra8x8PredMode (if available) that are previously (in decoding order) derived for adjacent macroblocks.


Output of this process is the variable Intra4x4PredMode[ luma4x4BlkIdx ].


Table 8-2 specifies the values for Intra4x4PredMode[ luma4x4BlkIdx ] and the associated names.


**Table 8-2 – Specification of Intra4x4PredMode[ luma4x4BlkIdx ] and associated names**

|Intra4x4PredMode[ luma4x4BlkIdx ]|Name of Intra4x4PredMode[ luma4x4BlkIdx ]|
|---|---|
|0|Intra_4x4_Vertical (prediction mode)|
|1|Intra_4x4_Horizontal (prediction mode)|
|2|Intra_4x4_DC (prediction mode)|
|3|Intra_4x4_Diagonal_Down_Left (prediction mode)|
|4|Intra_4x4_Diagonal_Down_Right (prediction mode)|
|5|Intra_4x4_Vertical_Right (prediction mode)|
|6|Intra_4x4_Horizontal_Down (prediction mode)|
|7|Intra_4x4_Vertical_Left (prediction mode)|
|8|Intra_4x4_Horizontal_Up (prediction mode)|






Intra4x4PredMode[ luma4x4BlkIdx ] labelled 0, 1, 3, 4, 5, 6, 7, and 8 represent directions of predictions as illustrated in
Figure 8-1.


**Figure 8-1 – Intra_4x4 prediction mode directions (informative)**


Intra4x4PredMode[ luma4x4BlkIdx ] is derived as specified by the following ordered steps:


1. The process specified in clause 6.4.11.4 is invoked with luma4x4BlkIdx given as input and the output is assigned

to mbAddrA, luma4x4BlkIdxA, mbAddrB, and luma4x4BlkIdxB.


2. The variable dcPredModePredictedFlag is derived as follows:


      - If any of the following conditions are true, dcPredModePredictedFlag is set equal to 1


        - the macroblock with address mbAddrA is not available


        - the macroblock with address mbAddrB is not available


        - the macroblock with address mbAddrA is available and coded in an Inter macroblock prediction mode
and constrained_intra_pred_flag is equal to 1


        - the macroblock with address mbAddrB is available and coded in an Inter macroblock prediction mode
and constrained_intra_pred_flag is equal to 1


      - Otherwise, dcPredModePredictedFlag is set equal to 0.


3. For N being either replaced by A or B, the variables intraMxMPredModeN are derived as follows:


      - If dcPredModePredictedFlag is equal to 1 or the macroblock with address mbAddrN is not coded in
Intra_4x4 or Intra_8x8 macroblock prediction mode, intraMxMPredModeN is set equal to 2 (Intra_4x4_DC
prediction mode).


      - Otherwise (dcPredModePredictedFlag is equal to 0 and the macroblock with address mbAddrN is coded in
Intra_4x4 or Intra_8x8 macroblock prediction mode), the following applies:


        - If the macroblock with address mbAddrN is coded in Intra_4x4 macroblock prediction mode,
intraMxMPredModeN is set equal to Intra4x4PredMode[ luma4x4BlkIdxN ], where
Intra4x4PredMode is the variable array assigned to the macroblock mbAddrN.


        - Otherwise (the macroblock with address mbAddrN is coded in Intra_8x8 macroblock prediction
mode), intraMxMPredModeN is set equal to Intra8x8PredMode[ luma4x4BlkIdxN >> 2 ], where
Intra8x8PredMode is the variable array assigned to the macroblock mbAddrN.


4. Intra4x4PredMode[ luma4x4BlkIdx ] is derived by applying the following procedure:


predIntra4x4PredMode = Min( intraMxMPredModeA, intraMxMPredModeB )
if( prev_intra4x4_pred_mode_flag[ luma4x4BlkIdx ] )
Intra4x4PredMode[ luma4x4BlkIdx ] = predIntra4x4PredMode
else (8-41)
if( rem_intra4x4_pred_mode[ luma4x4BlkIdx ] < predIntra4x4PredMode )
Intra4x4PredMode[ luma4x4BlkIdx ] = rem_intra4x4_pred_mode[ luma4x4BlkIdx ]
else
Intra4x4PredMode[ luma4x4BlkIdx ] = rem_intra4x4_pred_mode[ luma4x4BlkIdx ] +  133


**8.3.1.2** **Intra_4x4 sample prediction**


This process is invoked for each 4x4 luma block of a macroblock with macroblock prediction mode equal to Intra_4x4
followed by the transform decoding process and picture construction process prior to deblocking for each 4x4 luma block.


Inputs to this process are:


- the index of a 4x4 luma block luma4x4BlkIdx,


- an (PicWidthInSamplesL)x(PicHeightInSamplesL) array cSL containing constructed luma samples prior to the
deblocking filter process of neighbouring macroblocks.


Output of this process are the prediction samples pred4x4L[ x, y ], with x, y = 0..3, for the 4x4 luma block with index
luma4x4BlkIdx.


The position of the upper-left sample of a 4x4 luma block with index luma4x4BlkIdx inside the current macroblock is
derived by invoking the inverse 4x4 luma block scanning process in clause 6.4.3 with luma4x4BlkIdx as the input and the
output being assigned to ( xO, yO ).


The 13 neighbouring samples p[ x, y ] that are constructed luma samples prior to the deblocking filter process, with x = −1,
y = −1..3 and x = 0..7, y = −1, are derived as specified by the following ordered steps:


1. The luma location ( xN, yN ) is specified by


xN = xO + x (8-42)


yN = yO + y (8-43)


2. The derivation process for neighbouring locations in clause 6.4.12 is invoked for luma locations with ( xN, yN ) as

input and mbAddrN and ( xW, yW ) as output.


3. Each sample p[ x, y ] with x = −1, y = −1..3 and x = 0..7, y = −1 is derived as follows:


     - If any of the following conditions are true, the sample p[ x, y ] is marked as "not available for Intra_4x4
prediction"


        - mbAddrN is not available,


        - the macroblock mbAddrN is coded in an Inter macroblock prediction mode and
constrained_intra_pred_flag is equal to 1,


        - the macroblock mbAddrN has mb_type equal to SI and constrained_intra_pred_flag is equal to 1 and

the current macroblock does not have mb_type equal to SI,


        - x is greater than 3 and luma4x4BlkIdx is equal to 3 or 11.


     - Otherwise, the sample p[ x, y ] is marked as "available for Intra_4x4 prediction" and the value of the sample
p[ x, y ] is derived as specified by the following ordered steps:


a. The location of the upper-left luma sample of the macroblock mbAddrN is derived by invoking the
inverse macroblock scanning process in clause 6.4.1 with mbAddrN as the input and the output is
assigned to ( xM, yM ).


b. Depending on the variable MbaffFrameFlag and the macroblock mbAddrN, the sample value p[ x, y ]

is derived as follows:


           - If MbaffFrameFlag is equal to 1 and the macroblock mbAddrN is a field macroblock,


p[ x, y ] = cSL[ xM + xW, yM + 2 * yW ] (8-44)


           - Otherwise (MbaffFrameFlag is equal to 0 or the macroblock mbAddrN is a frame macroblock),


p[ x, y ] = cSL[ xM + xW, yM + yW ] (8-45)


When samples p[ x, −1 ], with x = 4..7, are marked as "not available for Intra_4x4 prediction," and the sample p[ 3, −1 ] is
marked as "available for Intra_4x4 prediction," the sample value of p[ 3, −1 ] is substituted for sample values p[ x, −1 ],
with x = 4..7, and samples p[ x, −1 ], with x = 4..7, are marked as "available for Intra_4x4 prediction".

NOTE – Each block is assumed to be constructed into a picture array prior to decoding of the next block.


Depending on Intra4x4PredMode[ luma4x4BlkIdx ], one of the Intra_4x4 prediction modes specified in clauses 8.3.1.2.1
to 8.3.1.2.9 is invoked.





**8.3.1.2.1** **Specification of Intra_4x4_Vertical prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 0.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..3 are marked as "available for Intra_4x4 prediction".


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived by


pred4x4L[ x, y ] = p[ x, −1 ], with x, y = 0..3 (8-46)


**8.3.1.2.2** **Specification of Intra_4x4_Horizontal prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 1.


This mode shall be used only when the samples p[ −1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction".


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived by


pred4x4L[ x, y ] = p[ −1, y ], with x,y = 0..3 (8-47)


**8.3.1.2.3** **Specification of Intra_4x4_DC prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 2.


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If all samples p[ x, −1 ], with x = 0..3, and p[ −1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction",
the values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived by


pred4x4L[ x, y ] = ( p[ 0, −1 ] + p[ 1, −1 ] + p[ 2, −1 ] + p[ 3, −1 ] +
p[ −1, 0 ] + p[ −1, 1 ] + p[ −1, 2 ] + p[ −1, 3 ] + 4 ) >> 3 (8-48)


- Otherwise, if any samples p[ x, −1 ], with x = 0..3, are marked as "not available for Intra_4x4 prediction" and all
samples p[ −1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction", the values of the prediction
samples pred4x4L[ x, y ], with x, y = 0..3, are derived by


pred4x4L[ x, y ] = ( p[ −1, 0 ] + p[ −1, 1 ] + p[ −1, 2 ] + p[ −1, 3 ] + 2 ) >> 2 (8-49)


- Otherwise, if any samples p[ −1, y ], with y = 0..3, are marked as "not available for Intra_4x4 prediction" and all
samples p[ x, −1 ], with x = 0 .. 3, are marked as "available for Intra_4x4 prediction", the values of the prediction
samples pred4x4L[ x, y ], with x, y = 0 .. 3, are derived by


pred4x4L[ x, y ] = ( p[ 0, −1 ] + p[ 1, −1 ] + p[ 2, −1 ] + p[ 3, −1 ] + 2 ) >> 2 (8-50)


- Otherwise (some samples p[ x, −1 ], with x = 0..3, and some samples p[ −1, y ], with y = 0..3, are marked as "not
available for Intra_4x4 prediction"), the values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived
by


pred4x4L[ x, y ] = ( 1 << ( BitDepthY − 1 ) ) (8-51)


NOTE – A 4x4 luma block can always be predicted using this mode.


**8.3.1.2.4** **Specification of Intra_4x4_Diagonal_Down_Left prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 3.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 are marked as "available for Intra_4x4 prediction".


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If x is equal to 3 and y is equal to 3,


pred4x4L[ x, y ] = ( p[ 6, −1 ] + 3 * p[ 7, −1 ] + 2 ) >> 2 (8-52)


- Otherwise (x is not equal to 3 or y is not equal to 3),


pred4x4L[ x, y ] = ( p[ x + y, −1 ] + 2 * p[ x + y + 1, −1 ] + p[ x + y + 2, −1 ] + 2 ) >> 2 (8-53)





**8.3.1.2.5** **Specification of Intra_4x4_Diagonal_Down_Right prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 4.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..3 and p[ −1, y ] with y = −1..3 are marked as "available
for Intra_4x4 prediction".


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If x is greater than y,


pred4x4L[ x, y ] = ( p[ x − y − 2, −1] + 2 * p[ x − y − 1, −1 ] + p[ x − y, −1 ] + 2 ) >> 2 (8-54)


- Otherwise if x is less than y,


pred4x4L[ x, y ] = ( p[ −1, y − x − 2 ] + 2 * p[ −1, y − x − 1 ] + p[ −1, y − x ] + 2 ) >> 2 (8-55)


- Otherwise (x is equal to y),


pred4x4L[ x, y ] = ( p[ 0, −1 ] + 2 * p[ −1, −1 ] + p[ −1, 0 ] + 2 ) >> 2 (8-56)


**8.3.1.2.6** **Specification of Intra_4x4_Vertical_Right prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 5.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..3 and p[ −1, y ] with y = −1..3 are marked as "available
for Intra_4x4 prediction".


Let the variable zVR be set equal to 2 * x − y.


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If zVR is equal to 0, 2, 4, or 6,


pred4x4L[ x, y ] = ( p[ x − ( y >> 1 ) − 1, −1 ] + p[ x − ( y >> 1 ), −1 ] + 1 ) >> 1 (8-57)


- Otherwise, if zVR is equal to 1, 3, or 5,


pred4x4L[ x, y ] = ( p[ x − ( y >> 1 ) − 2, −1] + 2 * p[ x − ( y >> 1 ) − 1, −1 ] + p[ x − ( y >> 1 ), −1 ] + 2 ) >> 2
(8-58)


- Otherwise, if zVR is equal to −1,


pred4x4L[ x, y ] = ( p[ −1, 0 ] + 2 * p[ −1, −1 ] + p[ 0, −1 ] + 2 ) >> 2 (8-59)


- Otherwise (zVR is equal to −2 or −3),


pred4x4L[ x, y ] = ( p[ −1, y − 1 ] + 2 * p[ −1, y − 2 ] + p[ −1, y − 3 ] + 2 ) >> 2 (8-60)


**8.3.1.2.7** **Specification of Intra_4x4_Horizontal_Down prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 6.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..3 and p[ −1, y ] with y = −1..3 are marked as "available
for Intra_4x4 prediction".


Let the variable zHD be set equal to 2 * y − x.


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If zHD is equal to 0, 2, 4, or 6,


pred4x4L[ x, y ] = ( p[ −1, y − ( x >> 1 ) − 1 ] + p[ −1, y − ( x >> 1 ) ] + 1 ) >> 1 (8-61)


- Otherwise, if zHD is equal to 1, 3, or 5,


pred4x4L[ x, y ] = ( p[ −1, y − ( x >> 1 ) − 2 ] + 2 * p[ −1, y − ( x >> 1 ) − 1 ] + p[ −1, y − ( x >> 1 ) ] + 2 ) >> 2
(8-62)


- Otherwise, if zHD is equal to −1,





pred4x4L[ x, y ] = ( p[ −1, 0 ] + 2 * p[ −1, −1 ] + p[ 0, −1 ] + 2 ) >> 2 (8-63)


- Otherwise (zHD is equal to −2 or −3),


pred4x4L[ x, y ] = ( p[ x − 1, −1 ] + 2 * p[ x − 2, −1 ] + p[ x − 3, −1 ] + 2 ) >> 2 (8-64)


**8.3.1.2.8** **Specification of Intra_4x4_Vertical_Left prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 7.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 are marked as "available for Intra_4x4 prediction".


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If y is equal to 0 or 2,


pred4x4L[ x, y ] = ( p[ x + ( y >> 1 ), −1 ] + p[ x + ( y >> 1 ) + 1, −1 ] + 1) >> 1 (8-65)


- Otherwise (y is equal to 1 or 3),


pred4x4L[ x, y ] = ( p[ x + ( y >> 1 ), −1 ] + 2 * p[ x + ( y >> 1 ) + 1, −1 ] + p[ x + ( y >> 1 ) + 2, −1 ] + 2 ) >> 2
(8-66)


**8.3.1.2.9** **Specification of Intra_4x4_Horizontal_Up prediction mode**


This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 8.


This mode shall be used only when the samples p[ −1, y ] with y = 0..3 are marked as "available for Intra_4x4 prediction".


Let the variable zHU be set equal to x + 2 * y.


The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived as follows:


- If zHU is equal to 0, 2, or 4


pred4x4L[ x, y ] = ( p[ −1, y + ( x >> 1 ) ] + p[ −1, y + ( x >> 1 ) + 1 ] + 1 ) >> 1 (8-67)


- Otherwise, if zHU is equal to 1 or 3


pred4x4L[ x, y ] = ( p[ −1, y + ( x >> 1 ) ] + 2 * p[ −1, y + ( x >> 1 ) + 1 ] + p[ −1, y + ( x >> 1 ) + 2 ] + 2 ) >> 2
(8-68)


- Otherwise, if zHU is equal to 5,


pred4x4L[ x, y ] = ( p[ −1, 2 ] + 3 * p[ −1, 3 ] + 2 ) >> 2 (8-69)


- Otherwise (zHU is greater than 5),


pred4x4L[ x, y ] = p[ −1, 3 ] (8-70)


**8.3.2** **Intra_8x8 prediction process for luma samples**


This process is invoked when the macroblock prediction mode is equal to Intra_8x8.


Inputs to this process are the values of Intra4x4PredMode (if available) or Intra8x8PredMode (if available) from the
neighbouring macroblocks or macroblock pairs.


Outputs of this process are 8x8 luma sample arrays as part of the 16x16 luma array of prediction samples of the macroblock
predL.


The luma component of a macroblock consists of 4 blocks of 8x8 luma samples. These blocks are inverse scanned using
the inverse 8x8 luma block scanning process as specified in clause 6.4.5.


For all 8x8 luma blocks of the luma component of a macroblock with luma8x8BlkIdx = 0..3, the derivation process for
Intra8x8PredMode as specified in clause 8.3.2.1 is invoked with luma8x8BlkIdx as well as Intra4x4PredMode and
Intra8x8PredMode that are previously (in decoding order) derived for adjacent macroblocks as the input and the variable
Intra8x8PredMode[ luma8x8BlkIdx ] as the output.


For each luma block of 8x8 samples indexed using luma8x8BlkIdx = 0..3, the following ordered steps are specified:





1. The Intra_8x8 sample prediction process in clause 8.3.2.2 is invoked with luma8x8BlkIdx and the array S′L

containing constructed samples prior to the deblocking filter process from adjacent luma blocks as the input and
the output are the Intra_8x8 luma prediction samples pred8x8L[ x, y ] with x, y = 0..7.


2. The position of the upper-left sample of an 8x8 luma block with index luma8x8BlkIdx inside the current

macroblock is derived by invoking the inverse 8x8 luma block scanning process in clause 6.4.5 with
luma8x8BlkIdx as the input and the output being assigned to ( xO, yO ).


3. The values of the prediction samples predL[ xO + x, yO + y ] with x, y = 0..7 are derived by


predL[ xO + x, yO + y ] = pred8x8L[ x, y ] (8-71)


4. The transform coefficient decoding process and picture construction process prior to deblocking filter process in

clause 8.5 is invoked with predL and luma8x8BlkIdx as the input and the constructed samples for the current 8x8
luma block S′L as the output.


**8.3.2.1** **Derivation process for Intra8x8PredMode**


Inputs to this process are the index of the 8x8 luma block luma8x8BlkIdx and variable arrays Intra4x4PredMode (if
available) and Intra8x8PredMode (if available) that are previously (in decoding order) derived for adjacent macroblocks.


Output of this process is the variable Intra8x8PredMode[ luma8x8BlkIdx ].


Table 8-3 specifies the values for Intra8x8PredMode[ luma8x8BlkIdx ] and the associated mnemonic names.


**Table 8-3 – Specification of Intra8x8PredMode[ luma8x8BlkIdx ] and associated names**

|Intra8x8PredMode[ luma8x8BlkIdx ]|Name of Intra8x8PredMode[ luma8x8BlkIdx ]|
|---|---|
|0|Intra_8x8_Vertical (prediction mode)|
|1|Intra_8x8_Horizontal (prediction mode)|
|2|Intra_8x8_DC (prediction mode)|
|3|Intra_8x8_Diagonal_Down_Left (prediction mode)|
|4|Intra_8x8_Diagonal_Down_Right (prediction mode)|
|5|Intra_8x8_Vertical_Right (prediction mode)|
|6|Intra_8x8_Horizontal_Down (prediction mode)|
|7|Intra_8x8_Vertical_Left (prediction mode)|
|8|Intra_8x8_Horizontal_Up (prediction mode)|



Intra8x8PredMode[ luma8x8BlkIdx ] is derived as specified by the following ordered steps:


1. The process specified in clause 6.4.11.2 is invoked with luma8x8BlkIdx given as input and the output is assigned

to mbAddrA, luma8x8BlkIdxA, mbAddrB, and luma8x8BlkIdxB.


2. The variable dcPredModePredictedFlag is derived as follows:


    - If any of the following conditions are true, dcPredModePredictedFlag is set equal to 1:


       - the macroblock with address mbAddrA is not available,


       - the macroblock with address mbAddrB is not available,


       - the macroblock with address mbAddrA is available and coded in an Inter macroblock prediction mode
and constrained_intra_pred_flag is equal to 1,


       - the macroblock with address mbAddrB is available and coded in an Inter macroblock prediction mode
and constrained_intra_pred_flag is equal to 1.


    - Otherwise, dcPredModePredictedFlag is set equal to 0.


3. For N being either replaced by A or B, the variables intraMxMPredModeN are derived as follows:





    - If dcPredModePredictedFlag is equal to 1 or the macroblock with address mbAddrN is not coded in Intra_4x4
or Intra_8x8 macroblock prediction mode, intraMxMPredModeN is set equal to 2 (Intra_8x8_DC prediction
mode).


    - Otherwise (dcPredModePredictedFlag is equal to 0 and (the macroblock with address mbAddrN is coded in
Intra_4x4 macroblock prediction mode or the macroblock with address mbAddrN is coded in Intra_8x8
macroblock prediction mode)), the following applies:


       - If the macroblock with address mbAddrN is coded in Intra_8x8 macroblock prediction mode,
intraMxMPredModeN is set equal to Intra8x8PredMode[ luma8x8BlkIdxN ], where Intra8x8PredMode
is the variable array assigned to the macroblock mbAddrN.


       - Otherwise (the macroblock with address mbAddrN is coded in Intra_4x4 macroblock prediction mode),
intraMxMPredModeN is derived by the following procedure, where Intra4x4PredMode is the variable
array assigned to the macroblock mbAddrN.


intraMxMPredModeN = Intra4x4PredMode[ luma8x8BlkIdxN * 4 + n ] (8-72)


where the variable n is derived as follows:


          - If N is equal to A, depending on the variable MbaffFrameFlag, the variable luma8x8BlkIdx, the
current macroblock, and the macroblock mbAddrN, the following applies:


            - If MbaffFrameFlag is equal to 1, the current macroblock is a frame coded macroblock, the
macroblock mbAddrN is a field coded macroblock, and luma8x8BlkIdx is equal to 2, n is set
equal to 3.


            - Otherwise (MbaffFrameFlag is equal to 0 or the current macroblock is a field coded
macroblock or the macroblock mbAddrN is a frame coded macroblock or luma8x8BlkIdx is
not equal to 2), n is set equal to 1.


          - Otherwise (N is equal to B), n is set equal to 2.


4. Finally, given intraMxMPredModeA and intraMxMPredModeB, the variable
Intra8x8PredMode[ luma8x8BlkIdx ] is derived by applying the following procedure.


predIntra8x8PredMode = Min( intraMxMPredModeA, intraMxMPredModeB )
if( prev_intra8x8_pred_mode_flag[ luma8x8BlkIdx ] )
Intra8x8PredMode[ luma8x8BlkIdx ] = predIntra8x8PredMode
else (8-73)
if( rem_intra8x8_pred_mode[ luma8x8BlkIdx ] < predIntra8x8PredMode )
Intra8x8PredMode[ luma8x8BlkIdx ] = rem_intra8x8_pred_mode[ luma8x8BlkIdx ]
else
Intra8x8PredMode[ luma8x8BlkIdx ] = rem_intra8x8_pred_mode[ luma8x8BlkIdx ] + 1


**8.3.2.2** **Intra_8x8 sample prediction**


This process is invoked for each 8x8 luma block of a macroblock with macroblock prediction mode equal to Intra_8x8
followed by the transform decoding process and picture construction process prior to deblocking for each 8x8 luma block.


Inputs to this process are:


- the index of an 8x8 luma block luma8x8BlkIdx,


- an (PicWidthInSamplesL)x(PicHeightInSamplesL) array cSL containing constructed luma samples prior to the
deblocking filter process of neighbouring macroblocks.


Output of this process are the prediction samples pred8x8L[ x, y ], with x, y = 0..7, for the 8x8 luma block with index
luma8x8BlkIdx.


The position of the upper-left sample of an 8x8 luma block with index luma8x8BlkIdx inside the current macroblock is
derived by invoking the inverse 8x8 luma block scanning process in clause 6.4.5 with luma8x8BlkIdx as the input and the
output being assigned to ( xO, yO ).


The 25 neighbouring samples p[ x, y ] that are constructed luma samples prior to the deblocking filter process, with x = −1,
y = −1..7 and x = 0..15, y = −1, are derived as specified by the following ordered steps:


1. The luma location ( xN, yN ) is specified by


xN = xO + x (8-74)





yN = yO + y (8-75)


2. The derivation process for neighbouring locations in clause 6.4.12 is invoked for luma locations with ( xN, yN ) as

input and mbAddrN and ( xW, yW ) as output.


3. Each sample p[ x, y ] with x = −1, y = −1..7 and x = 0..15, y = −1 is derived as follows:


    - If any of the following conditions are true, the sample p[ x, y ] is marked as "not available for Intra_8x8
prediction":


       - mbAddrN is not available,


       - the macroblock mbAddrN is coded in an Inter macroblock prediction mode and
constrained_intra_pred_flag is equal to 1.


    - Otherwise, the sample p[ x, y ] is marked as "available for Intra_8x8 prediction" and the sample value p[ x, y ]
is derived as specified by the following ordered steps:


a. The location of the upper-left luma sample of the macroblock mbAddrN is derived by invoking the
inverse macroblock scanning process in clause 6.4.1 with mbAddrN as the input and the output is
assigned to ( xM, yM ).


b. Depending on the variable MbaffFrameFlag and the macroblock mbAddrN, the sample value p[ x, y ]

is derived as follows:


           - If MbaffFrameFlag is equal to 1 and the macroblock mbAddrN is a field macroblock,


p[ x, y ] = cSL[ xM + xW, yM + 2 * yW ] (8-76)


           - Otherwise (MbaffFrameFlag is equal to 0 or the macroblock mbAddrN is a frame macroblock),


p[ x, y ] = cSL[ xM + xW, yM + yW ] (8-77)


When samples p[ x, −1 ], with x = 8..15, are marked as "not available for Intra_8x8 prediction," and the sample p[ 7, −1 ]
is marked as "available for Intra_8x8 prediction," the sample value of p[ 7, −1 ] is substituted for sample values p[ x, −1 ],
with x = 8..15, and samples p[ x, −1 ], with x = 8..15, are marked as "available for Intra_8x8 prediction".

NOTE – Each block is assumed to be constructed into a picture array prior to decoding of the next block.


The reference sample filtering process for Intra_8x8 sample prediction in clause 8.3.2.2.1 is invoked with the samples
p[ x, y ] with x = −1, y = −1..7 and x = 0..15, y = −1 (if available) as input and p′[ x, y ] with x = −1, y = −1..7 and
x = 0..15, y = −1 as output.


Depending on Intra8x8PredMode[ luma8x8BlkIdx ], one of the Intra_8x8 prediction modes specified in clauses 8.3.2.2.2
to 8.3.2.2.10 is invoked.


**8.3.2.2.1** **Reference sample filtering process for Intra_8x8 sample prediction**


Inputs to this process are the reference samples p[ x, y ] with x = −1, y = −1..7 and x = 0..15, y = −1 (if available) for
Intra_8x8 sample prediction.


Outputs of this process are the filtered reference samples p′[ x, y ] with x = −1, y = −1..7 and x = 0..15, y = −1 for Intra_8x8
sample prediction.


When all samples p[ x, −1 ] with x = 0..15 are marked as "available for Intra_8x8 prediction", the following applies:


1. The value of p′[ 0, −1 ] is derived as follows:


     - If p[ −1, −1 ] is marked as "available for Intra_8x8 prediction", p′[ 0, −1 ] is derived by


p′[ 0, −1 ] = ( p[ −1, −1 ] + 2 * p[ 0, −1 ] + p[ 1, −1 ] + 2 ) >> 2 (8-78)


     - Otherwise (p[ −1, −1 ] is marked as "not available for Intra_8x8 prediction"), p′[ 0, −1 ] is derived by


p′[ 0, −1 ] = ( 3 * p[ 0, −1 ] + p[ 1, −1 ] + 2 ) >> 2 (8-79)


2. The values of p′[ x, −1 ], with x = 1..14, are derived by


p′[ x, −1 ] = ( p[ x − 1, −1 ] + 2 * p[ x, −1 ] + p[ x+1, −1 ] + 2 ) >> 2 (8-80)


3. The value of p′[ 15, −1 ] is derived by





p′[ 15, −1 ] = ( p[ 14, −1 ] + 3 * p[ 15, −1 ] + 2 ) >> 2 (8-81)


When the sample p[ −1, −1 ] is marked as "available for Intra_8x8 prediction", the value of p′[ −1, −1 ] is derived as
follows:


- If the sample p[ 0, −1 ] is marked as "not available for Intra_8x8 prediction" or the sample p[ −1, 0 ] is marked as "not
available for Intra_8x8 prediction", the following applies:


   - If the sample p[ 0, −1 ] is marked as "available for Intra_8x8 prediction", p′[ −1, −1 ] is derived by


p′[ −1, −1 ] = ( 3 * p[ −1, −1 ] + p[ 0, −1 ] + 2 ) >> 2 (8- 28 )


   - Otherwise, if the sample p[ 0, −1 ] is marked as "not available for Intra_8x8 prediction" and the sample p[ −1, 0 ]
is marked as "available for Intra_8x8 prediction", p′[ −1, −1 ] is derived by


p′[ −1, −1 ] = ( 3 * p[ −1, −1 ] + p[ −1, 0 ] + 2) >> 2 (8-83)


   - Otherwise (the sample p[ 0, −1 ] is marked as "not available for Intra_8x8 prediction" and the sample p[ −1, 0 ]
is marked as "not available for Intra_8x8 prediction"), p′[ −1, −1 ] is set equal to p[ −1, −1 ].

NOTE – When both samples p[ 0, −1 ] and p[ −1, 0 ] are marked as "not available for Intra_8x8 prediction", the derived
sample p′[ −1, −1 ] is not used in the intra prediction process.


- Otherwise (the sample p[ 0, −1 ] is marked as "available for Intra_8x8 prediction" and the sample p[ −1, 0 ] is marked
as "available for Intra_8x8 prediction"), p′[ −1, −1 ] is derived by


p′[ −1, −1 ] = ( p[ 0, −1 ] + 2 * p[ −1, −1 ] + p[ −1, 0 ] + 2) >> 2 (8-84)


When all samples p[ −1, y ] with y = 0..7 are marked as "available for Intra_8x8 prediction", the following applies:


1. The value of p′[ −1, 0 ] is derived as follows:


     - If p[ −1, −1 ] is marked as "available for Intra_8x8 prediction", p′[ −1, 0 ] is derived by


p′[ −1, 0 ] = ( p[ −1, −1 ] + 2 * p[ −1, 0 ] + p[ −1, 1 ] + 2 ) >> 2 (8-85)


     - Otherwise (p[ −1, −1 ] is marked as "not available for Intra_8x8 prediction"), p′[ −1, 0 ] is derived by


p′[ −1, 0 ] = ( 3 * p[ −1, 0 ] + p[ −1, 1 ] + 2 ) >> 2 (8-86)


2. The values of p′[ −1, y ], with y = 1..6, are derived by


p′[ −1, y ] = ( p[ −1, y − 1 ] + 2 * p[ −1, y ] + p[ −1, y+1 ] + 2 ) >> 2 (8-87)


3. The value of p′[ −1, 7 ] is derived by


p′[ −1, 7 ] = ( p[ −1, 6 ] + 3 * p[ −1, 7 ] + 2 ) >> 2 (8-88)


**8.3.2.2.2** **Specification of Intra_8x8_Vertical prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 0.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 are marked as "available for Intra_8x8 prediction".


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived by


pred8x8L[ x, y ] = p′[ x, −1 ], with x, y = 0..7 (8-89)


**8.3.2.2.3** **Specification of Intra_8x8_Horizontal prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 1.


This mode shall be used only when the samples p[ −1, y ], with y = 0..7, are marked as "available for Intra_8x8 prediction".


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived by


pred8x8L[ x, y ] = p′[ −1, y ], with x, y = 0..7 (8-90)





**8.3.2.2.4** **Specification of Intra_8x8_DC prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 2.


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If all samples p[ x, −1 ], with x = 0..7, and p[ −1, y ], with y = 0..7, are marked as "available for Intra_8x8 prediction,"
the values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived by



7



7 (8-91)
###### x,' − 1] +  ['p −,1 y ]' + 8)  4



7


###### L[ x, y ] = (  ['p x,' − 1] +  ['p −,1 y ]' + 8) 

_x_ ' = 0 _y_ ' = 0



pred8x8 [ x, y ] = ( ['p _x_,' - 1] + ['p -,1 _y_ ]' + 8)  4



_x_ ' = 0 _y_ ' =



' = 0




- Otherwise, if any samples p[ x, −1 ], with x = 0..7, are marked as "not available for Intra_8x8 prediction" and all
samples p[ −1, y ], with y = 0..7, are marked as "available for Intra_8x8 prediction", the values of the prediction
samples pred8x8L[ x, y ], with x, y = 0..7, are derived by



7



(8-92)
_y_ ]' + 4)  3



7
###### L[ x, y ] = (   ['p −,1 y ]' + 4) 

_y_ ' = 0



pred8x8 [ x, y ] = ( ['p -,1 _y_ ]' + 4)  3



_y_ ' =




- Otherwise, if any samples p[ −1, y ], with y = 0..7, are marked as "not available for Intra_8x8 prediction" and all
samples p[ x, −1 ], with x = 0..7, are marked as "available for Intra_8x8 prediction", the values of the prediction
samples pred8x8L[ x, y ], with x, y = 0..7, are derived by



7



(8-93)
_x_,' - ]1 + 4)  3



7
###### L[ x, y ] = (   ['p x,' − ]1 + 4) 

_x_ ' = 0



pred8x8 [ x, y ] = ( ['p _x_,' - ]1 + 4)  3



_x_ ' =




- Otherwise (some samples p[ x, −1 ], with x = 0..7, and some samples p[ −1, y ], with y = 0..7, are marked as "not
available for Intra_8x8 prediction"), the values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived
by


pred8x8L[ x, y ] = ( 1 << ( BitDepthY − 1 ) ) (8-94)


NOTE – An 8x8 luma block can always be predicted using this mode.


**8.3.2.2.5** **Specification of Intra_8x8_Diagonal_Down_Left prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 3.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..15 are marked as "available for Intra_8x8 prediction".


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If x is equal to 7 and y is equal to 7,


pred8x8L[ x, y ] = ( p′[ 14, −1 ] + 3 * p′[ 15, −1 ] + 2 ) >> 2 (8-95)


- Otherwise (x is not equal to 7 or y is not equal to 7),


pred8x8L[ x, y ] = ( p′[ x + y, −1 ] + 2 * p′[ x + y + 1, −1 ] + p′[ x + y + 2, −1 ] + 2 ) >> 2 (8-96)


**8.3.2.2.6** **Specification of Intra_8x8_Diagonal_Down_Right prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 4.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 and p[ −1, y ] with y = −1..7 are marked as
"available for Intra_8x8 prediction".


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If x is greater than y,


pred8x8L[ x, y ] = ( p′[ x − y − 2, −1] + 2 * p′[ x − y − 1, −1 ] + p′[ x − y, −1 ] + 2 ) >> 2 (8-97)


- Otherwise if x is less than y,


pred8x8L[ x, y ] = ( p′[ −1, y − x − 2 ] + 2 * p′[ −1, y − x − 1 ] + p′[ −1, y − x ] + 2 ) >> 2 (8-98)


- Otherwise (x is equal to y),





pred8x8L[ x, y ] = ( p′[ 0, −1 ] + 2 * p′[ −1, −1 ] + p′[ −1, 0 ] + 2 ) >> 2 (8-99)


**8.3.2.2.7** **Specification of Intra_8x8_Vertical_Right prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 5.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 and p[ −1, y ] with y = −1..7 are marked as
"available for Intra_8x8 prediction".


Let the variable zVR be set equal to 2 * x − y.


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If zVR is equal to 0, 2, 4, 6, 8, 10, 12, or 14


pred8x8L[ x, y ] = ( p′[ x − ( y >> 1 ) − 1, −1 ] + p′[ x − ( y >> 1 ), −1 ] + 1 ) >> 1 (8-100)


- Otherwise, if zVR is equal to 1, 3, 5, 7, 9, 11, or 13


pred8x8L[ x, y ] = ( p′[ x − ( y >> 1 ) − 2, −1] + 2 * p′[ x − ( y >> 1 ) − 1, −1 ] +
p′[ x − ( y >> 1 ), −1 ] + 2 ) >> 2 (8-101)


- Otherwise, if zVR is equal to −1,


pred8x8L[ x, y ] = ( p′[ −1, 0 ] + 2 * p′[ −1, −1 ] + p′[ 0, −1 ] + 2 ) >> 2 (8-102)


- Otherwise (zVR is equal to −2, −3, −4, −5, −6, or −7),


pred8x8L[ x, y ] = ( p′[ −1, y − 2*x − 1 ] + 2 * p′[ −1, y − 2*x − 2 ] + p′[ −1, y − 2*x − 3 ] + 2 ) >> 2 (8-103)


**8.3.2.2.8** **Specification of Intra_8x8_Horizontal_Down prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 6.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 and p[ −1, y ] with y = −1..7 are marked as
"available for Intra_8x8 prediction".


Let the variable zHD be set equal to 2 * y − x.


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If zHD is equal to 0, 2, 4, 6, 8, 10, 12, or 14


pred8x8L[ x, y ] = ( p′[ −1, y − ( x >> 1 ) − 1 ] + p′[ −1, y − ( x >> 1 ) ] + 1 ) >> 1 (8-104)


- Otherwise, if zHD is equal to 1, 3, 5, 7, 9, 11, or 13


pred8x8L[ x, y ] = ( p′[ −1, y − ( x >> 1 ) − 2 ] + 2 * p′[ −1, y − ( x >> 1 ) − 1 ] +
p′[ −1, y − ( x >> 1 ) ] + 2 ) >> 2 (8-105)


- Otherwise, if zHD is equal to −1,


pred8x8L[ x, y ] = ( p′[ −1, 0 ] + 2 * p′[ −1, −1 ] + p′[ 0, −1 ] + 2 ) >> 2 (8-106)


- Otherwise (zHD is equal to −2, −3, −4, −5, −6, −7),


pred8x8L[ x, y ] = ( p′[ x − 2*y − 1, −1 ] + 2 * p′[ x − 2*y − 2, −1 ] + p′[ x − 2*y − 3, −1 ] + 2 ) >> 2 (8-107)


**8.3.2.2.9** **Specification of Intra_8x8_Vertical_Left prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 7.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..15 are marked as "available for Intra_8x8 prediction".


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If y is equal to 0, 2, 4 or 6


pred8x8L[ x, y ] = ( p′[ x + ( y >> 1 ), −1 ] + p′[ x + ( y >> 1 ) + 1, −1 ] + 1) >> 1 (8-108)





- Otherwise (y is equal to 1, 3, 5, 7),


pred8x8L[ x, y ] = ( p′[ x + ( y >> 1 ), −1 ] + 2 * p′[ x + ( y >> 1 ) + 1, −1 ] +
p′[ x + ( y >> 1 ) + 2, −1 ] + 2 ) >>2 (8-109)


**8.3.2.2.10** **Specification of Intra_8x8_Horizontal_Up prediction mode**


This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 8.


This mode shall be used only when the samples p[ −1, y ] with y = 0..7 are marked as "available for Intra_8x8 prediction".


Let the variable zHU be set equal to x + 2 * y.


The values of the prediction samples pred8x8L[ x, y ], with x, y = 0..7, are derived as follows:


- If zHU is equal to 0, 2, 4, 6, 8, 10, or 12


pred8x8L[ x, y ] = ( p′[ −1, y + ( x >> 1 ) ] + p′[ −1, y + ( x >> 1 ) + 1 ] + 1 ) >> 1 (8-110)


- Otherwise, if zHU is equal to 1, 3, 5, 7, 9, or 11


pred8x8L[ x, y ] = ( p′[ −1, y + ( x >> 1 ) ] + 2 * p′[ −1, y + ( x >> 1 ) + 1 ] +
p′[ −1, y + ( x >> 1 ) + 2 ] + 2 ) >>2 (8-111)


- Otherwise, if zHU is equal to 13,


pred8x8L[ x, y ] = ( p′[ −1, 6 ] + 3 * p′[ −1, 7 ] + 2 ) >> 2 (8-112)


- Otherwise (zHU is greater than 13),


pred8x8L[ x, y ] = p′[ −1, 7 ] (8-113)


**8.3.3** **Intra_16x16 prediction process for luma samples**


This process is invoked when the macroblock prediction mode is equal to Intra_16x16. It specifies how the Intra prediction
luma samples for the current macroblock are derived.


Input to this process is a (PicWidthInSamplesL)x(PicHeightInSamplesL) array cSL containing constructed luma samples
prior to the deblocking filter process of neighbouring macroblocks.


Outputs of this process are Intra prediction luma samples for the current macroblock predL[ x, y ].


The 33 neighbouring samples p[ x, y ] that are constructed luma samples prior to the deblocking filter process, with x = −1,
y = −1..15 and with x = 0..15, y = −1, are derived as specified by the following ordered steps:


1. The derivation process for neighbouring locations in clause 6.4.12 is invoked for luma locations with ( x, y )

assigned to ( xN, yN ) as input and mbAddrN and ( xW, yW ) as output.


2. Each sample p[ x, y ] with x = −1, y = −1..15 and with x = 0..15, y = −1 is derived as follows:


    - If any of the following conditions are true, the sample p[ x, y ] is marked as "not available for Intra_16x16
prediction":


       - mbAddrN is not available,


       - the macroblock mbAddrN is coded in an Inter macroblock prediction mode and
constrained_intra_pred_flag is equal to 1,


       - the macroblock mbAddrN has mb_type equal to SI and constrained_intra_pred_flag is equal to 1.


    - Otherwise, the sample p[ x, y ] is marked as "available for Intra_16x16 prediction" and the value of the sample
p[ x, y ] is derived as specified by the following ordered steps:


a. The location of the upper-left luma sample of the macroblock mbAddrN is derived by invoking the
inverse macroblock scanning process in clause 6.4.1 with mbAddrN as the input and the output is
assigned to ( xM, yM ).


b. Depending on the variable MbaffFrameFlag and the macroblock mbAddrN, the sample value p[ x, y ]

is derived as follows:


           - If MbaffFrameFlag is equal to 1 and the macroblock mbAddrN is a field macroblock,





p[ x, y ] = cSL[ xM + xW, yM + 2 * yW ] (8-114)


           - Otherwise (MbaffFrameFlag is equal to 0 or the macroblock mbAddrN is a frame macroblock),


p[ x, y ] = cSL[ xM + xW, yM + yW ] (8-115)


Let predL[ x, y ] with x, y = 0..15 denote the prediction samples for the 16x16 luma block samples.


Intra_16x16 prediction modes are specified in Table 8-4.


**Table 8-4 – Specification of Intra16x16PredMode and associated names**

|Intra16x16PredMode|Name of Intra16x16PredMode|
|---|---|
|0|Intra_16x16_Vertical (prediction mode)|
|1|Intra_16x16_Horizontal (prediction mode)|
|2|Intra_16x16_DC (prediction mode)|
|3|Intra_16x16_Plane (prediction mode)|



Depending on Intra16x16PredMode, one of the Intra_16x16 prediction modes specified in clauses 8.3.3.1 to 8.3.3.4 is
invoked.


**8.3.3.1** **Specification of Intra_16x16_Vertical prediction mode**


This Intra_16x16 prediction mode shall be used only when the samples p[ x, −1 ] with x = 0..15 are marked as "available
for Intra_16x16 prediction".


The values of the prediction samples predL[ x, y ], with x, y = 0..15, are derived by


predL[ x, y ] = p[ x, −1 ], with x, y = 0..15 (8-116)


**8.3.3.2** **Specification of Intra_16x16_Horizontal prediction mode**


This Intra_16x16 prediction mode shall be used only when the samples p[−1, y] with y = 0..15 are marked as "available
for Intra_16x16 prediction".


The values of the prediction samples predL[ x, y ], with x, y = 0..15, are derived by


predL[ x, y ] = p[ −1, y ], with x, y = 0..15 (8-117)


**8.3.3.3** **Specification of Intra_16x16_DC prediction mode**


This Intra_16x16 prediction mode operates, depending on whether the neighbouring samples are marked as "available for
Intra_16x16 prediction", as follows:


- If all neighbouring samples p[ x, −1 ], with x = 0..15, and p[ −1, y ], with y = 0..15, are marked as "available for
Intra_16x16 prediction", the prediction for all luma samples in the macroblock is given by:



15



, - 1 + p - 1, y' + 16) 



15


##### predL[ x, y ] = (  15 p  x', − 1 +  15 p − 1, y' 

x' = 0 y' = 0



15 15, with x, y = 0..15 (8-118)
##### (  p  x', − 1 +  p − 1, y' + 16)  5



x' = 0



y' = 0




- Otherwise, if any of the neighbouring samples p[ x, −1 ], with x = 0..15, are marked as "not available for Intra_16x16
prediction" and all of the neighbouring samples p[ −1, y ], with y = 0..15, are marked as "available for Intra_16x16
prediction", the prediction for all luma samples in the macroblock is given by:



15


##### predL[ x, y ] = (  15 p − 1, y' + 8)  4



, with x, y = 0..15 (8-119)


#####  p − 1, y' + 8) 



=



y' = 0




- Otherwise, if any of the neighbouring samples p[ −1, y ], with y = 0..15, are marked as "not available for Intra_16x16
prediction" and all of the neighbouring samples p[ x, −1 ], with x = 0..15, are marked as "available for Intra_16x16
prediction", the prediction for all luma samples in the macroblock is given by:



15




- 1 + 8) 


###### predL[ x, y ] = (  p  x', − 1 



, with x, y = 0..15 (8-120)
###### (  p  x', − 1 + 8)  4



= 0



x' =  145


- Otherwise (some of the neighbouring samples p[ x, −1 ], with x = 0..15, and some of the neighbouring samples
p[ −1, y ], with y = 0..15, are marked as "not available for Intra_16x16 prediction"), the prediction for all luma samples
in the macroblock is given by:


predL[ x, y ] = ( 1 << ( BitDepthY − 1 ) ), with x, y = 0..15 (8-121)


**8.3.3.4** **Specification of Intra_16x16_Plane prediction mode**


This Intra_16x16 prediction mode shall be used only when the samples p[ x, −1 ] with x = −1..15 and p[ −1, y ] with
y = 0..15 are marked as "available for Intra_16x16 prediction".


The values of the prediction samples predL[ x, y ], with x, y = 0..15, are derived by


predL[ x, y ] = Clip1Y( ( a + b * ( x − 7 ) + c * ( y − 7 ) + 16 ) >> 5 ), with x, y = 0..15, (8-122)


where


a = 16 * ( p[ −1, 15 ] + p[ 15, −1 ] ) (8-123)


b = ( 5 * H + 32 ) >> 6 (8-124)


c = ( 5 * V + 32 ) >> 6 (8-125)


and H and V are specified as



7


#####  ( x' + ) 1 * p (  8 + x', − 1  p -  6 - x'-, 1 



(8-126)
##### H =  ( x' + ) 1 * p (  8 + x', − 1  p -  6 - x'-, 1  )



= ( x' + ) 1 - p ( 8 + x',


=



x' = 0



7



7 (8-127)
###### V =  (y' + ) 1 *p (  - 1,8 + y'  - p  - 1,6 - y')  


######  (y' + ) 1 *p (  - 1,8 + y'  - p  - 1,6 - y' 



= (y' + ) 1 *p ( - 1,8 +



=



y' = 0



**8.3.4** **Intra prediction process for chroma samples**


This process is invoked for I and SI macroblock types. It specifies how the Intra prediction chroma samples for the current
macroblock are derived.


Inputs to this process are two (PicWidthInSamplesC)x(PicHeightInSamplesC) arrays cSCb and cSCr containing constructed
chroma samples prior to the deblocking filter process of neighbouring macroblocks.


Outputs of this process are Intra prediction chroma samples for the current macroblock predCb[ x, y ] and predCr[ x, y ].


Depending on the value of ChromaArrayType, the following applies:


- If ChromaArrayType is equal to 3, the Intra prediction chroma samples for the current macroblock predCb[ x, y ] and
predCr[ x, y ] are derived using the Intra prediction process for chroma samples with ChromaArrayType equal to 3 as
specified in clause 8.3.4.5.


- Otherwise (ChromaArrayType is equal to 1 or 2), the following text specifies the Intra prediction chroma samples for
the current macroblock predCb[ x, y ] and predCr[ x, y ].


Both chroma blocks (Cb and Cr) of the macroblock use the same prediction mode. The prediction mode is applied to each
of the chroma blocks separately. The process specified in this clause is invoked for each chroma block. In the remainder
of this clause, chroma block refers to one of the two chroma blocks and the subscript C is used as a replacement of the
subscript Cb or Cr.


The neighbouring samples p[ x, y ] that are constructed chroma samples prior to the deblocking filter process, with x = −1,
y = −1..MbHeightC − 1 and with x = 0..MbWidthC − 1, y = −1, are derived as specified by the following ordered steps:


1. The derivation process for neighbouring locations in clause 6.4.12 is invoked for chroma locations with ( x, y )

assigned to ( xN, yN ) as input and mbAddrN and ( xW, yW ) as output.


2. Each sample p[ x, y ] is derived as follows:


    - If any of the following conditions are true, the sample p[ x, y ] is marked as "not available for Intra chroma
prediction":


       - mbAddrN is not available,





       - the macroblock mbAddrN is coded in an Inter macroblock prediction mode and
constrained_intra_pred_flag is equal to 1,


       - the macroblock mbAddrN has mb_type equal to SI and constrained_intra_pred_flag is equal to 1 and the
current macroblock does not have mb_type equal to SI.


    - Otherwise, the sample p[ x, y ] is marked as "available for Intra chroma prediction" and the value of the sample
p[ x, y ] is derived as specified by the following ordered steps:


a. The location of the upper-left luma sample of the macroblock mbAddrN is derived by invoking the
inverse macroblock scanning process in clause 6.4.1 with mbAddrN as the input and the output is
assigned to ( xL, yL ).


b. The location ( xM, yM ) of the upper-left chroma sample of the macroblock mbAddr is derived by:


xM =  ( xL >> 4 ) * MbWidthC (8-128)
yM = ( ( yL >> 4 )* MbHeightC ) + ( yL % 2 ) (8-129)


c. Depending on the variable MbaffFrameFlag and the macroblock mbAddrN, the sample value p[ x, y ]
is derived as follows:


           - If MbaffFrameFlag is equal to 1 and the macroblock mbAddrN is a field macroblock,


p[ x, y ] = cSC[ xM + xW, yM + 2 * yW ] (8-130)


           - Otherwise (MbaffFrameFlag is equal to 0 or the macroblock mbAddrN is a frame macroblock),


p[ x, y ] = cSC[ xM + xW, yM + yW ] (8-131)


Let predC[ x, y ] with x = 0..MbWidthC − 1, y = 0..MbHeightC − 1 denote the prediction samples for the chroma block
samples.


Intra chroma prediction modes are specified in Table 8-5.


**Table 8-5 – Specification of Intra chroma prediction modes and associated names**

|intra_chroma_pred_mode|Name of intra_chroma_pred_mode|
|---|---|
|0|Intra_Chroma_DC (prediction mode)|
|1|Intra_Chroma_Horizontal (prediction mode)|
|2|Intra_Chroma_Vertical (prediction mode)|
|3|Intra_Chroma_Plane (prediction mode)|



Depending on intra_chroma_pred_mode, one of the Intra chroma prediction modes specified in clauses 8.3.4.1 to 8.3.4.4
is invoked.


**8.3.4.1** **Specification of Intra_Chroma_DC prediction mode**


This Intra chroma prediction mode is invoked when intra_chroma_pred_mode is equal to 0.


For each chroma block of 4x4 samples indexed by chroma4x4BlkIdx = 0..( 1 << ( ChromaArrayType + 1 ) ) − 1, the
following applies:


- The position of the upper-left sample of a 4x4 chroma block with index chroma4x4BlkIdx inside the current
macroblock is derived by invoking the inverse 4x4 chroma block scanning process in clause 6.4.7 with
chroma4x4BlkIdx as the input and the output being assigned to ( xO, yO ).


- Depending on the values of xO and yO, the following applies:


   - If ( xO, yO ) is equal to ( 0, 0 ) or xO and yO are greater than 0, the values of the prediction samples
predC[ x + xO, y + yO ] with x, y = 0..3 are derived as follows:


      - If all samples p[ x + xO, −1 ], with x = 0..3, and p[ −1, y +yO ], with y = 0..3, are marked as "available for
Intra chroma prediction", the values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are
derived as:





 3 3
+ xO, y + yO ] =  []  p['x + xO, - 1] +  p[ -,1 'y + yO] +



 3 3 

 []  p['x + xO, - 1] +  p[ -,1 'y + yO] + 4  []
 x' = 0 y' = 0 



3



3



C[ x + xO, y + yO ] =  []  p['x + xO, - 1] +  p[ -,1 'y + yO] + 4  [] 

 x' = 0 y' = 0 



pred [ x + xO, y + yO ] = [] p['x + xO, - 1] + p[ -,1 'y + yO] + 4 []  3



, with x, y = 0..3. (8-132)



' = 0 y' =



y' = 0




- Otherwise, if any samples p[ x + xO, −1 ], with x = 0..3, are marked as "not available for Intra chroma
prediction" and all samples p[ −1, y +yO ], with y = 0..3, are marked as "available for Intra chroma
prediction", the values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3 
#####  []  [p −,1 'y + yO] + 2  []

 'y = 0 







3


##### + xO,y + yO ] =  []  [p −,1 'y + yO] +


##### C[ x + xO,y + yO ] =  []  [p −,1 'y + yO] + 2  [] 

 'y = 0 



pred [ x + xO,y + yO ] = [p -,1 'y + yO] + 2  2



, with x, y = 0..3. (8-133)



=




- Otherwise, if any samples p[ −1, y +yO ], with y = 0..3, are marked as "not available for Intra chroma
prediction" and all samples p[ x + xO, −1 ], with x = 0..3, are marked as "available for Intra chroma
prediction", the values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3
###### + xO, y + yO ] =  []  p['x + xO, − 1] +



 3 
######  []  p['x + xO, − 1] + 2  []

 x' = 0 



3


###### C[ x + xO, y + yO ] =  []  p['x + xO, − 1] + 2  [] 

 x' = 0 



pred [ x + xO, y + yO ] = [] p['x + xO, - 1] + 2 []  2



, with x, y = 0..3. (8-134)



=




   - Otherwise (some samples p[ x + xO, −1 ], with x = 0..3, and some samples p[ −1, y +yO ], with y = 0..3,
are marked as "not available for Intra chroma prediction"), the values of the prediction samples
predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:


predC[ x + xO, y + yO ] = ( 1 << ( BitDepthC − 1 ) ), with x, y = 0..3. (8-135)


- Otherwise, if xO is greater than 0 and yO is equal to 0, the values of the prediction samples
predC[ x + xO, y + yO ] with x, y = 0..3 are derived as follows:


   - If all samples p[ x + xO, −1 ], with x = 0..3, are marked as "available for Intra chroma prediction", the
values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3
###### + xO, y + yO ] =  []  p['x + xO, − 1] +



 3 
######  []  p['x + xO, − 1] + 2  []

 x' = 0 



3


###### C[ x + xO, y + yO ] =  []  p['x + xO, − 1] + 2  [] 

 x' = 0 



pred [ x + xO, y + yO ] = [] p['x + xO, - 1] + 2 []  2



, with x, y = 0..3. (8-136)



=




- Otherwise, if all samples p[ −1, y +yO ], with y = 0..3, are marked as "available for Intra chroma
prediction", the values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3 
#####  []  [p −,1 'y + yO] + 2  []

 'y = 0 







3


##### + xO,y + yO ] =  []  [p −,1 'y + yO] +


##### C[ x + xO,y + yO ] =  []  [p −,1 'y + yO] + 2  [] 

 'y = 0 



pred [ x + xO,y + yO ] = [p -,1 'y + yO] + 2  2



, with x, y = 0..3. (8-137)



=




   - Otherwise (some samples p[ x + xO, −1 ], with x = 0..3, and some samples p[ −1, y +yO ], with y = 0..3,
are marked as "not available for Intra chroma prediction"), the values of the prediction samples
predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:


predC[ x + xO, y + yO ] = ( 1 << ( BitDepthC − 1 ) ), with x, y = 0..3. (8-138)


- Otherwise (xO is equal to 0 and yO is greater than 0), the values of the prediction samples
predC[ x + xO, y + yO ] with x, y = 0..3 are derived as follows:


   - If all samples p[ −1, y +yO ], with y = 0..3, are marked as "available for Intra chroma prediction", the values
of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3 
#####  []  [p −,1 'y + yO] + 2  []

 'y = 0 







3


##### + xO,y + yO ] =  []  [p −,1 'y + yO] +


##### C[ x + xO,y + yO ] =  []  [p −,1 'y + yO] + 2  [] 

 'y = 0 



pred [ x + xO,y + yO ] = [p -,1 'y + yO] + 2  2



, with x, y = 0..3. (8-139)



=




- Otherwise, if all samples p[ x + xO, −1 ], with x = 0..3, are marked as "available for Intra chroma
prediction", the values of the prediction samples predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:



 3
###### + xO, y + yO ] =  []  p['x + xO, − 1] +



 3 
######  []  p['x + xO, − 1] + 2  []

 x' = 0 



3


###### C[ x + xO, y + yO ] =  []  p['x + xO, − 1] + 2  [] 

 x' = 0 



pred [ x + xO, y + yO ] = [] p['x + xO, - 1] + 2 []  2



, with x, y = 0..3. (8-140)



=






      - Otherwise (some samples p[ x + xO, −1 ], with x = 0..3, and some samples p[ −1, y +yO ], with y = 0..3,
are marked as "not available for Intra chroma prediction"), the values of the prediction samples
predC[ x + xO, y + yO ], with x, y = 0..3, are derived as:


predC[ x + xO, y + yO ] = ( 1 << ( BitDepthC − 1 ) ), with x, y = 0..3. (8-141)


**8.3.4.2** **Specification of Intra_Chroma_Horizontal prediction mode**


This Intra chroma prediction mode is invoked when intra_chroma_pred_mode is equal to 1.


This mode shall be used only when the samples p[ −1, y ] with y = 0..MbHeightC − 1 are marked as "available for Intra
chroma prediction".


The values of the prediction samples predC[ x, y ] are derived as:


predC[ x, y ] = p[ −1, y ], with x = 0..MbWidthC − 1 and y = 0..MbHeightC − 1 (8-142)


**8.3.4.3** **Specification of Intra_Chroma_Vertical prediction mode**


This Intra chroma prediction mode is invoked when intra_chroma_pred_mode is equal to 2.


This mode shall be used only when the samples p[ x, −1 ] with x = 0..MbWidthC − 1 are marked as "available for Intra
chroma prediction".


The values of the prediction samples predC[ x, y ] are derived as:


predC[ x, y ] = p[ x, −1 ], with x = 0..MbWidthC − 1 and y = 0..MbHeightC − 1 (8-143)


**8.3.4.4** **Specification of Intra_Chroma_Plane prediction mode**


This Intra chroma prediction mode is invoked when intra_chroma_pred_mode is equal to 3.


This mode shall be used only when the samples p[ x, −1 ], with x = 0..MbWidthC − 1 and p[ −1, y ], with
y = −1..MbHeightC − 1 are marked as "available for Intra chroma prediction".


Let the variable xCF be set equal to ( ( ChromaArrayType = = 3 ) ? 4 : 0 ) and let the variable yCF be set equal to
( ( ChromaArrayType != 1 ) ? 4 : 0 ).


The values of the prediction samples predC[ x, y ] are derived by:


predC[ x, y ] = Clip1C( ( a + b * ( x − 3 − xCF ) + c * ( y − 3 − yCF ) + 16 ) >> 5 ),
with x = 0..MbWidthC − 1 and y = 0..MbHeightC − 1 (8-144)


where


a = 16 * ( p[ −1, MbHeightC − 1 ] + p[ MbWidthC − 1, −1 ] ) (8-145)


b = ( ( 34 − 29 * ( ChromaArrayType = = 3 ) ) * H + 32 ) >> 6 (8-146)


c = ( ( 34 − 29 * ( ChromaArrayType != 1 ) ) * V + 32 ) >> 6 (8-147)


and H and V are specified as:



+



3 + xCF


####  ('x + )1 *(p  4 + xCF +,'x − 1 − p  2 + xCF −,'x − 1  )



= ('x + )1 *(p 4 + xCF +,'x - 1 - p 2 + xCF -,'x


H = ('x + )1 *(p 4 + xCF +,'x - 1 - p 2 + xCF -,'x - 1 )



(8-148)



=



'x = 0



+



3 + yCF


###### V =  ('y + 1) * (p[ −,14 + yCF + ]'y − p[ −,12 + yCF − 'y]) (8-149)


###### 

y' = 0



= ('y + 1) - (p[ -,14 + yCF + ]'y - p[ -,12 + yCF


=



**8.3.4.5** **Intra prediction for chroma samples with ChromaArrayType equal to 3**


This process is invoked when ChromaArrayType is equal to 3. This process is invoked for I and SI macroblock types. It
specifies how the Intra prediction chroma samples for the current macroblock are derived when ChromaArrayType is equal
to 3.


Inputs to this process are constructed samples prior to the deblocking filter process from neighbouring Cb and Cr blocks
and for Intra_NxN (where NxN is equal to 4x4 or 8x8) prediction mode, the associated values of IntraNxNPredMode from
neighbouring macroblocks.





Outputs of this process are the Intra prediction samples of the Cb and Cr components of the macroblock or in case of the
Intra_NxN prediction process, the outputs are NxN Cb sample arrays as part of the 16x16 Cb array of prediction samples
of the macroblock, and NxN Cb sample arrays as part of the 16x16 Cb array of prediction samples of the macroblock.


Each Cb, Cr, and luma block with the same block index of the macroblock use the same prediction mode. The prediction
mode is applied to each of the Cb and Cr blocks separately. The process specified in this clause is invoked for each Cb and
Cr block.


Depending on the macroblock prediction mode, the following applies:


- If the macroblock prediction mode is equal to Intra_4x4, the following applies:


   - The same process described in clause 8.3.1 is also applied to Cb or Cr samples, substituting luma with Cb or Cr,
substituting luma4x4BlkIdx with cb4x4BlkIdx or cr4x4BlkIdx, substituting pred4x4L with pred4x4Cb or
pred4x4Cr, and substituting BitDepthY with BitDepthC.


   - The output variable Intra4x4PredMode[luma4x4BlkIdx] from the process described in clause 8.3.1.1 is also used
for the 4x4 Cb or 4x4 Cr blocks with index luma4x4BlkIdx equal to index cb4x4BlkIdx or cr4x4BlkIdx.


   - The process to derive prediction Cb or Cr samples is identical to the process described in clause 8.3.1.2 and its
subsequent subclauses when substituting luma with Cb or Cr, substituting pred4x4L with pred4x4Cb or pred4x4Cr,
and substituting BitDepthY with BitDepthC.


- Otherwise, if the macroblock prediction mode is equal to Intra_8x8, the following applies:


   - The same process described in clause 8.3.2 is also applied to Cb or Cr samples, substituting luma with Cb or Cr,
substituting luma8x8BlkIdx with cb8x8BlkIdx or cr8x8BlkIdx, substituting pred8x8L with pred8x8Cb or
pred8x8Cr, and substituting BitDepthY with BitDepthC.


   - The output variable Intra8x8PredMode[luma8x8BlkIdx] from the process described in clause 8.3.2.1 is used for
the 8x8 Cb or 8x8 Cr blocks with index luma8x8BlkIdx equal to index cb8x8BlkIdx or cr8x8BlkIdx.


   - The process to derive prediction Cb or Cr samples is identical to the process described in clause 8.3.2.2 and its
subsequent subclauses when substituting luma with Cb or Cr, substituting pred8x8L with pred8x8Cb or pred8x8Cr,
and substituting BitDepthY with BitDepthC.


- Otherwise (the macroblock prediction mode is equal to Intra_16x16), the same process described in clause 8.3.3 and
its subsequent subclauses is also applied to Cb or Cr samples, substituting luma with Cb or Cr, substituting predL with
predCb or predCr, and substituting BitDepthY with BitDepthC.


**8.3.5** **Sample construction process for I_PCM macroblocks**


This process is invoked when mb_type is equal to I_PCM.


The variable dy is derived as follows:


- If MbaffFrameFlag is equal to 1 and the current macroblock is a field macroblock, dy is set equal to 2.


- Otherwise (MbaffFrameFlag is equal to 0 or the current macroblock is a frame macroblock), dy is set equal to 1.


The position of the upper-left luma sample of the current macroblock is derived by invoking the inverse macroblock
scanning process in clause 6.4.1 with CurrMbAddr as input and the output being assigned to ( xP, yP ).


The constructed luma samples prior to the deblocking process are generated as specified by:


for( i = 0; i < 256; i++ )
S′L[ xP + ( i % 16 ), yP + dy * ( i / 16 ) ) ] = pcm_sample_luma[ i ] (8-150)





When ChromaArrayType is not equal to 0, the constructed chroma samples prior to the deblocking process are generated
as specified by:


for( i = 0; i < MbWidthC * MbHeightC; i++ ) {
S′Cb[ ( xP / SubWidthC ) + ( i % MbWidthC ),
( ( yP + SubHeightC − 1 ) / SubHeightC ) + dy * ( i / MbWidthC ) ] =
pcm_sample_chroma[ i ] (8-151)
S′Cr[ ( xP / SubWidthC ) + ( i % MbWidthC ),
( ( yP + SubHeightC − 1 ) / SubHeightC ) + dy * ( i / MbWidthC ) ] =
pcm_sample_chroma[ i + MbWidthC * MbHeightC ]
}
