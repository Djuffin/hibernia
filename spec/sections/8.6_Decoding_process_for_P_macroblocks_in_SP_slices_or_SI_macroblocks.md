**8.6** **Decoding process for P macroblocks in SP slices or SI macroblocks**


This process is invoked when decoding P macroblock types in an SP slice type or the SI macroblock type in SI slices.


Inputs to this process are the prediction residual transform coefficient levels and the predicted samples for the current
macroblock.


Outputs of this process are the decoded samples of the current macroblock prior to the deblocking filter process.


This clause specifies the transform coefficient decoding process and picture construction process for P macroblock types
in SP slices and the SI macroblock type in SI slices.

NOTE – SP slices make use of Inter predictive coding to exploit temporal redundancy in the sequence, in a similar manner to P slice
coding. Unlike P slice coding, however, SP slice coding allows identical reconstruction of a slice even when different reference
pictures are being used. SI slices make use of spatial prediction, in a similar manner to I slices. SI slice coding allows identical





reconstruction to a corresponding SP slice. The properties of SP and SI slices aid in providing functionalities for bitstream switching,
splicing, random access, fast-forward, fast reverse, and error resilience/recovery.


An SP slice consists of macroblocks coded either as I macroblock types or P macroblock types.


An SI slice consists of macroblocks coded either as I macroblock types or SI macroblock type.


The transform coefficient decoding process and picture construction process prior to deblocking filter process for I
macroblock types in SI slices is invoked as specified in clause 8.5. The SI macroblock type is decoded as described below.


When the current macroblock is coded as P_Skip, all values of LumaLevel4x4, ChromaDCLevel, ChromaACLevel are set
equal to 0 for the current macroblock.


**8.6.1** **SP decoding process for non-switching pictures**


This process is invoked, when decoding P macroblock types in SP slices in which sp_for_switch_flag is equal to 0.


Inputs to this process are Inter prediction samples for the current macroblock from clause 8.4 and the prediction residual
transform coefficient levels.


Outputs of this process are the decoded samples of the current macroblock prior to the deblocking filter process.


This clause applies to all macroblocks in SP slices in which sp_for_switch_flag is equal to 0, except those with macroblock
prediction mode equal to Intra_4x4 or Intra_16x16. It does not apply to SI slices.


**8.6.1.1** **Luma transform coefficient decoding process**


Inputs to this process are Inter prediction luma samples for the current macroblock predL from clause 8.4 and the prediction
residual transform coefficient levels, LumaLevel4x4, and the index of the 4x4 luma block luma4x4BlkIdx.


The position of the upper-left sample of the 4x4 luma block with index luma4x4BlkIdx inside the current macroblock is
derived by invoking the inverse 4x4 luma block scanning process in clause 6.4.3 with luma4x4BlkIdx as the input and the
output being assigned to ( x, y ).


Let the variable p be a 4x4 array of prediction samples with element pij being derived as:


pij = predL[ x + j, y + i ]  with i, j = 0..3 (8-414)


The variable p is transformed producing transform coefficients c [p] according to:



















- 1


p00 p01 p02 p03



p30 p31 p32 p33



 1 2 1 1


















1 1  - 1
 










1 1 - 1 - 2


 1 - 1 - 1 2


1 - 2 1 - 1



p00 p01 p02 p

p10 p11 p12 p

p p p p



10 11 12 13

20 p21 p22 p23



c



_p_ =  10 11 12 13  (8-415)



2 1  - 1
= 














1 1 1 1

2 1 - 1 - 2

1 - 1 - 1 1

1 - 2 2 - 1




- 1



- 2 2





























- 2 1


The inverse scanning process for 4x4 transform coefficients and scaling lists as specified in clause 8.5.6 is invoked with
LumaLevel4x4[ luma4x4BlkIdx ] as the input and the two-dimensional array c [r] with elements cij [r] as the output.


The prediction residual transform coefficients c [r] are scaled using quantization parameter QPY, and added to the transform
coefficients of the prediction block c [p] with i, j = 0..3 as follows:


cij [s] = cij [p] + ( ( ( cij [r]      - LevelScale4x4( QPY % 6, i, j ) * Aij ) << ( QPY / 6 ) ) >> 10 ) (8-416)


where LevelScale4x4( m, i, j ) is specified in Equation 8-313, and Aij is specified as:



 16 for (i, j) 

=  25 for (i, j) 










 16 for (i, j)  {(0,0), (0,2), (2,0), (2,2)},

Aij =  25 for (i, j)  {(1,1), (1,3), (3,1), (3,3)}, (8-417)



25 for (i, j)  {(1,1), (1,3), (3,1), (3,3)},



20 otherwise;



The function LevelScale2( m, i, j ), used in the formulas below, is specified as



 wm0 for (i, j) 

=  w for (i, j) 










 wm0 for (i, j)  {(0,0), (0,2), (2,0), (2,2)},

LevelScale 2(m, i, j) =  w for (i, j)  {(1,1), (1,3), (3,1), (3,3)},



m0

m1

m2



w for (i, j)  {(1,1), (1,3), (3,1), (3,3)},



(8-418)



w otherwise;



where the first and second subscripts of w are row and column indices, respectively, of the matrix specified as





w = (8-419)



=













13107 5243 8066

11916 4660 7490

10082 4194 6554







9362 3647 5825

8192 3355 5243

7282 2893 4559

















The resulting sum, c [s], is quantized with a quantization parameter QSY and with i, j = 0..3 as follows:


cij = Sign( cij [s] ) * ( ( Abs( cij [s] ) * LevelScale2( QSY % 6, i, j ) + ( 1 << ( 14 + QSY / 6 ) ) ) >> ( 15 + QSY / 6 ) )
(8-420)


The scaling and transformation process for residual 4x4 blocks as specified in clause 8.5.12 is invoked with c as the input
and r as the output.


The 4x4 array u with elements uij is derived by:


uij = Clip1Y( rij ) with i, j = 0..3 (8-421)


The picture construction process prior to deblocking filter process in clause 8.5.14 is invoked with luma4x4BlkIdx and u
as the inputs.


**8.6.1.2** **Chroma transform coefficient decoding process**


Inputs to this process are Inter prediction chroma samples for the current macroblock from clause 8.4 and the prediction
residual transform coefficient levels, ChromaDCLevel and ChromaACLevel.


This process is invoked twice: once for the Cb component and once for the Cr component. The component is referred to
by replacing C with Cb for the Cb component and C with Cr for the Cr component. Let iCbCr select the current chroma
component.


For each 4x4 block of the current chroma component indexed using chroma4x4BlkIdx with chroma4x4BlkIdx equal
to 0..3, the following ordered steps are specified:


1. The position of the upper-left sample of a 4x4 chroma block with index chroma4x4BlkIdx inside the macroblock
is derived by invoking the inverse 4x4 chroma block scanning process in clause 6.4.7 with chroma4x4BlkIdx as
the input and the output being assigned to ( xO, yO ).


2. Let p be a 4x4 array of prediction samples with elements pij being derived as


pij = predC[ x + j, y + i ]  with i, j = 0..3 (8-422)


3. The 4x4 array p is transformed producing transform coefficients c [p] ( chroma4x4BlkIdx ) using Equation 8-415.


4. The variable chromaList, which is a list of 16 entries, is derived. chromaList[ 0 ] is set equal to 0. chromaList[ k ]
with index k = 1..15 are specified as follows:


chromaList[ k ] = ChromaACLevel[ iCbCr ][ chroma4x4BlkIdx ][ k − 1 ] (8-423)


5. The inverse scanning process for 4x4 transform coefficients and scaling lists as specified in clause 8.5.6 is invoked
with chromaList as the input and the 4x4 array c [r] as the output.


6. The prediction residual transform coefficients c [r] are scaled using quantization parameter QPC, and added to the
transform coefficients of the prediction block c [p] with i, j = 0..3 except for the combination i = 0, j = 0 as follows:


cij [s] = cij [p] ( chroma4x4BlkIdx ) + ( ( ( cij [r]        - LevelScale4x4( QPC % 6, i, j ) * Aij ) << ( QPC / 6 ) ) >> 10 ) (8-424)


7. The resulting sum, c [s], is quantized with a quantization parameter QSC and with i, j = 0..3 except for the combination
i = 0, j = 0 as follows. The derivation of c00( chroma4x4BlkIdx ) is described below in this clause.


cij( chroma4x4BlkIdx ) = ( Sign( cij [s] ) * ( Abs( cij [s] ) * LevelScale2( QSC % 6, i, j ) +
( 1 << ( 14 + QSC / 6 ) ) ) ) >> ( 15 + QSC / 6 ) (8-425)


8. The scaling and transformation process for residual 4x4 blocks as specified in clause 8.5.12 is invoked with
c( chroma4x4BlkIdx ) as the input and r as the output.


9. The 4x4 array u with elements uij is derived by:





uij = Clip1C( rij ) with i, j = 0..3 (8-426)


10. The picture construction process prior to deblocking filter process in clause 8.5.14 is invoked with

chroma4x4BlkIdx and u as the inputs.


The derivation of the DC transform coefficient level c00( chroma4x4BlkIdx ) is specified as follows. The DC transform
coefficients of the 4 prediction chroma 4x4 blocks of the current component of the macroblock are assembled into a 2x2
matrix with elements c00 [p] (chroma4x4BlkIdx) and a 2x2 transform is applied to the DC transform coefficients as follows:



p =  1 1    c00p )0( c00p )1(    1 1  (8-427)



 1 1 

 1 - 1 







 cc0000pp ( )0( )2 cc00p00p )3( )1( 



dcp =  11 - 11    cc0000pp ( )0( )2 cc00p00p







 
  1


 1 1 

 1 - 1 







 1 1



=

 1


 

  



1 - 1



c00p )0( c00p )1(

cp ( )2 cp )3(



1 - 1



The chroma DC prediction residual transform coefficient levels, ChromaDCLevel[ iCbCr ][ k ] with k = 0..3 are scaled
using quantization parameter QPC, and added to the prediction DC transform coefficients as follows:


dcij [s] = dcij [p] + ( ( ( ChromaDCLevel[ iCbCr ][ j * 2 + i ] * LevelScale4x4( QPC % 6, 0, 0) * A00 ) << ( QPC / 6 ) )

>> 9 ) with i, j = 0, 1 (8-428)


The 2x2 array dc [s], is quantized using the quantization parameter QSC as follows:


dcij [r] = ( Sign( dcij [s] ) * ( Abs( dcij [s] ) * LevelScale2( QSC % 6, 0, 0) + ( 1 << ( 15 + QSC / 6 ) ) ) ) >> ( 16 + QSC / 6 )

with i, j = 0, 1 (8-429)


The 2x2 array f with elements fij and i, j = 0..1 is derived as:



 1 1 

 1 - 1 







 

  



 dcdc1000rr dcdc1101rr 



00r dc01r    1 1  (8-430)







f =  11 - 11    dcdc1000rr dcdc1101rr



 
  1


 1 1 

 1 - 1 







1 1



11 - 11    dcdc00rr dcdc



=  1 - 1    dc00r dc01r    1 - 1



dcr dc



Scaling of the elements fij of f is performed as follows:


c00( j * 2 + i ) = ( ( fij * LevelScale4x4( QSC % 6, 0, 0 ) ) << ( QSC / 6 ) ) >> 5 with i, j = 0, 1 (8-431)


**8.6.2** **SP and SI slice decoding process for switching pictures**


This process is invoked, when decoding P macroblock types in SP slices in which sp_for_switch_flag is equal to 1 and
when decoding the SI macroblock type in SI slices.


Inputs to this process are the prediction residual transform coefficient levels and the prediction sample arrays predL, predCb
and predCr for the current macroblock.


**8.6.2.1** **Luma transform coefficient decoding process**


Inputs to this process are prediction luma samples predL and the luma prediction residual transform coefficient levels,
LumaLevel4x4.


The 4x4 array p with elements pij with i, j = 0..3 is derived as in clause 8.6.1.1, is transformed according to Equation 8-415
to produce transform coefficients c [p] . These transform coefficients are then quantized with the quantization parameter QSY,
as follows:


cij [s] = Sign( cij [p] ) * ( ( Abs( cij [p] ) * LevelScale2( QSY % 6, i, j ) + ( 1 << ( 14 + QSY / 6 ) ) ) >> ( 15 + QSY / 6 ) )
with i, j = 0..3 (8-432)


The inverse scanning process for 4x4 transform coefficients and scaling lists as specified in clause 8.5.6 is invoked with
LumaLevel4x4[ luma4x4BlkIdx ] as the input and the two-dimensional array c [r] with elements cij [r] as the output.


The 4x4 array c with elements cij with i, j = 0..3 is derived by:


cij = cij [r] + cij [s] with i, j = 0..3 (8-433)


The scaling and transformation process for residual 4x4 blocks as specified in clause 8.5.12 is invoked with c as the input
and r as the output.


The 4x4 array u with elements uij is derived by:


uij = Clip1Y( rij ) with i, j = 0..3 (8-434)





The picture construction process prior to deblocking filter process in clause 8.5.14 is invoked with luma4x4BlkIdx and u
as the inputs.


**8.6.2.2** **Chroma transform coefficient decoding process**


Inputs to this process are predicted chroma samples for the current macroblock from clause 8.4 and the prediction residual
transform coefficient levels, ChromaDCLevel and ChromaACLevel.


This process is invoked twice: once for the Cb component and once for the Cr component. The component is referred to
by replacing C with Cb for the Cb component and C with Cr for the Cr component. Let iCbCr select the current chroma
component.


For each 4x4 block of the current chroma component indexed using chroma4x4BlkIdx with chroma4x4BlkIdx equal
to 0..3, the following ordered steps are specified:


1. The 4x4 array p with elements pij with i, j = 0..3 is derived as in clause 8.6.1.2, is transformed according to
Equation 8-415 to produce transform coefficients c [p] ( chroma4x4BlkIdx ). These transform coefficients are then
quantized with the quantization parameter QSC, with i, j = 0..3 except for the combination i = 0, j = 0 as follows.
The processing of c00 [p] ( chroma4x4BlkIdx ) is described below in this clause.


cij [s] = ( Sign( cij [p] ( chroma4x4BlkIdx ) ) * ( Abs( cij [p] ( chroma4x4BlkIdx ) ) *
LevelScale2( QSC % 6, i, j ) + ( 1 << ( 14 + QSC / 6 ) ) ) ) >> ( 15 + QSC / 6) (8-435)


2. The variable chromaList, which is a list of 16 entries, is derived. chromaList[ 0 ] is set equal to 0. chromaList[ k ]
with index k = 1..15 are specified as follows:


chromaList[ k ] = ChromaACLevel[ iCbCr ][ chroma4x4BlkIdx ][ k − 1 ] (8-436)


3. The inverse scanning process for 4x4 transform coefficients and scaling lists as specified in clause 8.5.6 is invoked
with chromaList as the input and the two-dimensional array c [r] ( chroma4x4BlkIdx ) with elements
cij [r] ( chroma4x4BlkIdx ) as the output.


4. The 4x4 array c( chroma4x4BlkIdx ) with elements cij( chroma4x4BlkIdx ) with i, j = 0..3 except for the
combination i = 0, j = 0 is derived as follows. The derivation of c00( chroma4x4BlkIdx ) is described below.


cij( chroma4x4BlkIdx ) = cij [r] ( chroma4x4BlkIdx ) + cij [s] (8-437)


5. The scaling and transformation process for residual 4x4 blocks as specified in clause 8.5.12 is invoked with
c( chroma4x4BlkIdx ) as the input and r as the output.


6. The 4x4 array u with elements uij is derived by:


uij = Clip1C( rij ) with i, j = 0..3 (8-438)


7. The picture construction process prior to deblocking filter process in clause 8.5.14 is invoked with
chroma4x4BlkIdx and u as the inputs.


The derivation of the DC transform coefficient level c00( chroma4x4BlkIdx ) is specified as follows. The DC transform
coefficients of the 4 prediction 4x4 chroma blocks of the current component of the macroblock, c00 [p] ( chroma4x4BlkIdx ),
are assembled into a 2x2 matrix, and a 2x2 transform is applied to the DC transform coefficients of these blocks according
to Equation 8-427 resulting in DC transform coefficients dcij [p] .


These DC transform coefficients are then quantized with the quantization parameter QSC, as given by:


dcij [s] = ( Sign( dcij [p] ) * ( Abs( dcij [p] ) * LevelScale2( QSC % 6, 0, 0 ) + ( 1 << ( 15 + QSC / 6 ) ) ) ) >>
( 16 + QSC / 6 ) with i, j = 0, 1 (8-439)


The parsed chroma DC prediction residual transform coefficients, ChromaDCLevel[ iCbCr ][ k ] with k = 0..3 are added
to these quantized DC transform coefficients of the prediction block, as given by:


dcij [r] = dcij [s] + ChromaDCLevel[ iCbCr ][ j * 2 + i ] with i, j = 0, 1 (8-440)


The 2x2 array f with elements fij and i, j = 0..1 is derived using Equation 8-430.


The 2x2 array f with elements fij and i, j = 0..1 is copied as follows:


c00( j * 2 + i ) = fij with i, j = 0, 1 (8-441)
